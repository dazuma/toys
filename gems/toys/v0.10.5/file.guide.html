<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: Toys User Guide
  
    &mdash; Toys
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "guide";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: Toys User Guide</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="toys-user-guide">Toys User Guide</h1>

<p>Toys is a configurable command line tool. Write commands in Ruby using a simple
DSL, and Toys will provide the command line executable and take care of all the
details such as argument parsing, online help, and error reporting.</p>

<p>Toys is designed for software developers, IT professionals, and other power
users who want to write and organize scripts to automate their workflows. It
can also be used as a Rake replacement, providing a more natural command line
interface for your project&#39;s build tasks.</p>

<p>Unlike most command line frameworks, Toys is <em>not primarily</em> designed to help
you build and ship a custom command line executable written in Ruby. Rather, it
provides a single executable called <code>toys</code>. You define the commands recognized
by the Toys executable by writing configuration files. (You can, however, build
your own custom command line executable using the related <strong>toys-core</strong>
library.)</p>

<p>If this is your first time using Toys, we recommend starting with the
<a href="https://dazuma.github.io/toys/gems/toys/latest">README</a>, which includes a
tutorial that introduces how to install Toys, write and execute tools, and even
use Toys to replace Rake. The tutorial will likely give you enough information
to start using Toys effectively.</p>

<p>This user&#39;s guide is also structured like an extended tutorial, but it is much
longer and covers all the features of Toys in much more depth. Read it when
you&#39;re ready to unlock all the capabilities of Toys to create sophisticated
command line tools.</p>

<h2 id="conceptual-overview">Conceptual overview</h2>

<p>Toys is a command line <em>framework</em>. It provides an executable called <code>toys</code>
with basic functions such as argument parsing and online help. You provide the
actual behavior of the Toys executable by writing <strong>Toys files</strong>.</p>

<p>Toys is a multi-command executable. You may define any number of commands,
called <strong>tools</strong>, which can be invoked by passing the tool name as an argument
to the <code>toys</code> executable. Tools are arranged in a hierarchy; you may define
<strong>namespaces</strong> that have <strong>subtools</strong>.</p>

<p>Tools may recognize command line arguments in the form of <strong>flags</strong> and
<strong>positional arguments</strong>. Flags can optionally take <strong>values</strong>, while
positional arguments may be <strong>required</strong> or <strong>optional</strong>. Flags may be
organized into <strong>flag groups</strong> which support different kinds of constraints on
which flags are required.</p>

<p>The configuration of a tool may include <strong>descriptions</strong>, for the tool itself,
and for each command line argument. These descriptions are displayed in the
tool&#39;s <strong>online help</strong> screen. Descriptions come in <strong>long</strong> and <strong>short</strong>
forms, which appear in different styles of help.</p>

<p>Toys searches for tools in specifically-named <strong>Toys files</strong> and <strong>Toys
directories</strong>. It searches for these in the current directory, in its
ancestors, and in the Toys <strong>search path</strong>.</p>

<p>Toys provides various features to help you write tools. This includes providing
a <strong>logger</strong> for each tool, <strong>mixins</strong> that provide common functions a tool can
call (such as to control subprocesses and style output), and <strong>templates</strong>
which are prefabricated tools that you can configure for your needs.</p>

<p>Finally, Toys provides useful <strong>built-in behavior</strong>, including automatically
providing flags to display help screens and set verbosity. It also includes a
built-in namespace of <strong>system tools</strong> that let you inspect and configure the
Toys system itself.</p>

<h2 id="the-toys-command-line">The Toys command line</h2>

<p>In this section, you will learn how Toys parses its command line, identifies a
tool to run, and interprets flags and other command line arguments.</p>

<p>The general form of the <code>toys</code> command line is:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_toys'>toys</span> <span class='lbracket'>[</span><span class='const'>TOOL</span><span class='op'>...</span><span class='rbracket'>]</span> <span class='lbracket'>[</span><span class='const'>FLAGS</span><span class='op'>...</span><span class='rbracket'>]</span> <span class='lbracket'>[</span><span class='const'>ARGS</span><span class='op'>...</span><span class='rbracket'>]</span>
</code></pre>

<h3 id="tools">Tools</h3>

<p>The <strong>tool name</strong> consists of all the command line arguments until the first
argument that begins with a hyphen (which is interpreted as a <strong>flag</strong>), until
no tool with that name exists (in which case the argument is treated as the
first <strong>positional argument</strong>), or until there are no more arguments.</p>

<p>For example, in the following command:</p>

<pre class="code ruby"><code class="ruby">       |----TOOL----|
$ toys system version
</code></pre>

<p>The tool name is <code>system version</code>. Notice that the tool name may have multiple
words. Tools are arranged hierarchically. In this case, <code>system</code> is a
<strong>namespace</strong> for tools related to the Toys system, and <code>version</code> is one of its
<strong>subtools</strong>. It prints the current Toys version.</p>

<p>The words in a tool name can be delimited with spaces as shown above, or
alternately periods or colons. The following commands also invoke the tool
<code>system version</code>:</p>

<pre class="code ruby"><code class="ruby">$ toys system.version
$ toys system:version
</code></pre>

<p>In the following command:</p>

<pre class="code ruby"><code class="ruby">       |TOOL| |ARG|
$ toys system frodo
</code></pre>

<p>There is no subtool <code>frodo</code> under the <code>system</code> namespace, so Toys works
backward until it finds an existing tool. In this case, the <code>system</code> namespace
itself does exist, so Toys runs <em>it</em> as the tool, and passes it <code>frodo</code> as an
argument.</p>

<p>Namespaces such as <code>system</code> are themselves tools and can be executed like any
other tool. In the above case, it takes the argument <code>frodo</code>, determines it has
no subtool of that name, and prints an error message. More commonly, though,
you might execute a namespace without arguments:</p>

<pre class="code ruby"><code class="ruby">$ toys system
</code></pre>

<p>This displays the <strong>online help screen</strong> for the <code>system</code> namespace, which
includes a list of all its subtools and what they do.</p>

<p>It is also legitimate for the tool name to be empty. This invokes the <strong>root
tool</strong>, the toplevel namespace:</p>

<pre class="code ruby"><code class="ruby">$ toys
</code></pre>

<p>Like any namespace, invoking the root tool displays its help screen, including
showing the list of all its subtools.</p>

<p>One last example:</p>

<pre class="code ruby"><code class="ruby">$ toys frodo
</code></pre>

<p>If there is no tool called <code>frodo</code> in the toplevel namespace, then once again,
<code>frodo</code> is interpreted as an argument to the root tool. The root tool responds
by printing an error message that the <code>frodo</code> tool does not exist.</p>

<h3 id="flags">Flags</h3>

<p><strong>Flags</strong> are generally arguments that begin with a hyphen, and are used to set
options for a tool.</p>

<p>Each tool recognizes a specific set of flags. If you pass an unknown flag to a
tool, the tool will generally display an error message.</p>

<p>Toys follows the typical unix conventions for flags, specifically those covered
by Ruby&#39;s OptionParser library. You can provide short (single-character) flags
with a single hyphen, or long flags with a double hyphen. Some flags can also
take <strong>values</strong>. Following are a few examples.</p>

<p>Here we pass a single short flag (for verbose output).</p>

<pre class="code ruby"><code class="ruby">$ toys system -v
</code></pre>

<p>Here we pass multiple long flags (for verbose output and recursive subtool
search).</p>

<pre class="code ruby"><code class="ruby">$ toys system --verbose --recursive
</code></pre>

<p>You can combine short flags. The following passes both the <code>-v</code> and <code>-r</code> flags
(i.e. it has the same effect as the previous example.)</p>

<pre class="code ruby"><code class="ruby">$ toys system -vr
</code></pre>

<p>Long flags can be abbreviated, as long as the abbreviation is not ambiguous.
For example, there is only one flag (<code>--recursive</code>) beginning with the string
<code>--rec</code>, so you can use the shortened form.</p>

<pre class="code ruby"><code class="ruby">$ toys --rec
</code></pre>

<p>However, there are two flags (<code>--version</code> and <code>--verbose</code>) beginning with
<code>--ver</code>, so it cannot be used as an abbreviation. This will cause an error:</p>

<pre class="code ruby"><code class="ruby">$ toys --ver
</code></pre>

<p>Some flags take values. The root tool supports the <code>--search</code> flag to search
for tools that have the given keyword.</p>

<pre class="code ruby"><code class="ruby">$ toys --search=build
$ toys --search build
</code></pre>

<p>The short form of the search flag <code>-s</code> also takes a value.</p>

<pre class="code ruby"><code class="ruby">$ toys -s build
$ toys -sbuild
</code></pre>

<p>If a double hyphen <code>--</code> appears by itself in the arguments, it disables flag
parsing from that point. Any further arguments are treated as positional
arguments, even if they begin with hyphens. For example:</p>

<pre class="code ruby"><code class="ruby">       |--FLAG--|   |---ARG---|
$ toys --verbose -- --recursive
</code></pre>

<p>That will cause <code>--recursive</code> to be treated as a positional argument. (In this
case, as we saw earlier, the root tool will respond by printing an error
message that no tool named <code>--recursive</code> exists.)</p>

<p>Note that a single hyphen by itself <code>-</code> is not considered a flag, nor does it
disable flag parsing. It is treated as a normal positional argument.</p>

<h4 id="standard-flags">Standard flags</h4>

<p>For the most part, each tool specifies which flags and arguments it recognizes.
However, Toys adds a few standard flags globally to every tool. (It is possible
for individual tools to override these flags, but most tools should support
them.) These standard flags include:</p>

<ul>
<li>  <code>--help</code> (also <code>-?</code>) which displays the full help screen for the tool.</li>
<li>  <code>--usage</code> which displays a shorter usage screen for the tool.</li>
<li>  <code>--verbose</code> (also <code>-v</code>) which increases the verbosity. This affects the
tool&#39;s logging display, increasing the number of log levels shown. This
flag may be issued multiple times.</li>
<li>  <code>--quiet</code> (also <code>-q</code>) which decreases the verbosity. This affects the
tool&#39;s logging display, decreasing the number of log levels shown. This
flag may also be issued multiple times.</li>
</ul>

<p>Namespace tools (tools that have subtools but no explicit functionality of
their own) always behave as though <code>--help</code> is invoked. (They do recognize the
flag, but it has no additional effect.) Namespaces also support the following
additional flags:</p>

<ul>
<li>  <code>--all</code> which displays all subtools, including
<a href="#Hidden_tools">hidden subtools</a> and namespaces.</li>
<li>  <code>--no-recursive</code> which displays only immediate subtools, instead of the
default behavior of showing all subtools recursively.</li>
<li>  <code>--search=TERM</code> which displays only subtools whose name or description
contain the specified search term.</li>
<li>  <code>--tools</code> which displays just the list of subtools rather than the entire
help screen.</li>
</ul>

<p>Finally, the root tool also supports:</p>

<ul>
<li>  <code>--version</code> which displays the current Toys version.</li>
</ul>

<h3 id="positional-arguments">Positional arguments</h3>

<p>Any arguments not recognized as flags or flag arguments, are interpreted as
<strong>positional arguments</strong>. Positional arguments are recognized in order and may
be required or optional.</p>

<p>Each tool recognizes a specific set of positional arguments. If you do not pass
a value for a required argument, or you pass too many arguments, the tool will
generally display an error message.</p>

<p>For example, the built-in <code>do</code> tool runs multiple tools in sequence. It
recognizes any number of positional arguments. Those arguments specify which
tools to run and what arguments to pass to them. If, for example, you had a
<code>build</code> tool and a <code>test</code> tool, you could run them in sequence with:</p>

<pre class="code ruby"><code class="ruby">          |---ARGS---|
$ toys do build , test
</code></pre>

<p>The three arguments <code>build</code> and <code>,</code> and <code>test</code> are positional arguments to the
<code>do</code> tool. (The <code>do</code> tool uses <code>,</code> to delimit the tools that it should run.)</p>

<p>Most tools allow flags and positional arguments to be interspersed. A flag will
be recognized even if it appears after some of the positional arguments.</p>

<p>However, this approach would not work for the <code>do</code> tool because its common case
is to pass flags down to the steps it runs. (That is, <code>do</code> wants most arguments
to be treated as positional even if they look like flags.) So <code>do</code> stops
recognizing flags once it encounters its first positional argument. That is,
you could do this:</p>

<pre class="code ruby"><code class="ruby">          |------------ARGS-----------|
$ toys do build --staging , test --help
</code></pre>

<p>Each tool can choose which behavior it will support, whether or not to enforce
<a href="#Enforcing_flags_before_args">flags before positional args</a>.</p>

<p>You can also, of course, stop recognizing flags on the command line by passing
<code>--</code> as an argument.</p>

<h3 id="tab-completion">Tab completion</h3>

<p>If you are using the Bash shell, Toys provides custom tab completion. See
<a href="#Installing_tab_completion_for_Bash">this section</a> for instructions on
installing tab completion.</p>

<p>Toys will complete tool and subtool names, flags, values passed to flags, and
positional argument values, and it will respect the current context. For
example, if you type:</p>

<pre class="code ruby"><code class="ruby">$ toys &lt;TAB&gt;&lt;TAB&gt;
</code></pre>

<p>The tab completion will show you a list of reasonable things that could appear
next, including the defined tool names (such as <code>system</code> and <code>do</code>) as well as
all the flags supported by the root tool (such as <code>--help</code> and <code>-v</code>). And of
course, if you start typing something, tab completion will limit the display to
matching completions. The following displays only flags, i.e. completions that
begin with a hyphen:</p>

<pre class="code ruby"><code class="ruby">$ toys -&lt;TAB&gt;&lt;TAB&gt;
</code></pre>

<p>And if you type the following:</p>

<pre class="code ruby"><code class="ruby">$ toys sys&lt;TAB&gt;
</code></pre>

<p>It is likely only one tool name starts with <code>sys</code>, so completion will
automatically type the rest of <code>system</code> for you.</p>

<p>The tab completion for Toys also supports values passed to flags and positional
args. As we shall see later, when you define a flag or a positional argument,
you can specify how completions are computed.</p>

<p><strong>Note:</strong> Because of the highly dynamic nature of Toys in which tools, flags,
and arguments can be highly customized, the completion implementation actually
requires <em>executing Toys</em> so it can analyze your tool configurations. This
unfortunately means paying some upfront latency as the Ruby interpreter starts
up. So you can expect a slight pause when evaluating tab completion for Toys,
at least in comparison with most other tab completions.</p>

<h2 id="defining-tools">Defining tools</h2>

<p>So far we&#39;ve been experimenting only with the built-in tools provided by Toys.
In this section, you will learn how to define tools by writing a <strong>Toys file</strong>.
We will cover how to write tools, including specifying the functionality of the
tool, the flags and arguments it takes, and how its description appears in the
help screen.</p>

<h3 id="basic-toys-syntax">Basic Toys syntax</h3>

<p>A file named <code>.toys.rb</code> (note the leading period) in the current working
directory is called a <strong>Toys file</strong>. It defines tools available in that
directory and its subdirectories.</p>

<p>The format of a Toys file is a Ruby DSL that includes directives, methods, and
nested blocks. The actual DSL is specified in the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool">Toys::DSL::Tool class</a>.</p>

<p>To create a tool, write a <code>tool</code> block, giving the tool a name. Within the
block, use directives to set the properties of the tool, including descriptions
and the flags and arguments recognized by the tool. The actual functionality of
the tool is set by defining a <code>run</code> method.</p>

<p>Let&#39;s start with an example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_desc'>desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Print a friendly greeting.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_long_desc'>long_desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Prints a friendly greeting. You may customize whom to</span><span class='tstring_end'>&quot;</span></span> \
              <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> greet, and how friendly it should be.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Example:</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>    toys greet --shout ruby</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Whom to greet.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-s</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--shout</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Greet loudly.</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='id identifier rubyid_greeting'>greeting</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='kw'>if</span> <span class='id identifier rubyid_shout'>shout</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_greeting'>greeting</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Its results should be mostly self-evident. But let&#39;s unpack a few details.</p>

<h3 id="tool-descriptions">Tool descriptions</h3>

<p>Each tool may have a <strong>short description</strong> and/or a <strong>long description</strong>. The
short description is a generally a single string that is displayed with the
tool name, at the top of its help page or in a subtool list. The long
description generally includes multiple strings, which are displayed in
multiple lines in the &quot;description&quot; section of the tool&#39;s help page. Long
descriptions may include blank lines to separate paragraphs visually.</p>

<p>By default, each description string/line is word-wrapped when displayed. In the
long description example above, the first line is a bit longer than 80
characters, and may be word-wrapped if displayed on an 80-character terminal.</p>

<p>If you need to control the wrapping behavior, pass an array of strings for that
line. Each array element will be considered a unit for wrapping purposes, and
will not be split. The example command in the long description above
illustrates how to prevent a line from being word-wrapped. This is also a
useful technique for preserving spaces and indentation.</p>

<p>For more details, see the reference documentation for
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#desc-instance_method">Toys::DSL::Tool#desc</a>
and
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#long_desc-instance_method">Toys::DSL::Tool#long_desc</a>.</p>

<h3 id="positional-arguments">Positional arguments</h3>

<p>Tools may recognize any number of <strong>positional arguments</strong>. Each argument must
have a name, which is a key that the tool can use to obtain the argument&#39;s
value at execution time. Arguments may also have various properties controlling
how values are validated and expressed.</p>

<p>The above example uses the directive
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#optional_arg-instance_method">Toys::DSL::Tool#optional_arg</a>
to declare an <strong>optional argument</strong> named <code>:whom</code>. If the argument is provided
on the command line e.g.</p>

<pre class="code ruby"><code class="ruby">$ toys greet ruby
Hello, ruby!
</code></pre>

<p>Then the option <code>:whom</code> is set to the string <code>&quot;ruby&quot;</code>. Otherwise, if the
argument is omitted, e.g.</p>

<pre class="code ruby"><code class="ruby">$ toys greet
Hello, world!
</code></pre>

<p>Then the option <code>:whom</code> is set to the default value <code>&quot;world&quot;</code>.</p>

<p>If the option name is a valid method name, Toys will provide a method that you
can use to retrieve the value. In the above example, we retrieve the value for
the option <code>:whom</code> by calling the method <code>whom</code>. If the option name cannot be
made into a method, you can retrieve the value by calling
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#get-instance_method">Toys::Context#get</a>.</p>

<p>An argument may also be <strong>required</strong>, which means it must be provided on the
command line; otherwise the tool will report a usage error. You may declare a
required argument using the directive
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#required_arg-instance_method">Toys::DSL::Tool#required_arg</a>.</p>

<h4 id="parsing-required-and-optional-arguments">Parsing required and optional arguments</h4>

<p>When command line arguments are parsed, the required arguments are matched
first, in order, followed by the optional arguments. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>args-demo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:arg2</span>
  <span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:arg1</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>options data is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If a user runs</p>

<pre class="code ruby"><code class="ruby">$ toys args-demo foo
Options data is {arg1: &quot;foo&quot;, arg2: nil}
</code></pre>

<p>Then the required argument <code>:arg1</code> will be set to <code>&quot;foo&quot;</code>, and the optional
argument <code>:arg2</code> will not be set (i.e. it will remain <code>nil</code>).</p>

<p>If the user runs:</p>

<pre class="code ruby"><code class="ruby">$ toys args-demo foo bar
Options data is {arg1: &quot;foo&quot;, arg2: &quot;bar&quot;}
</code></pre>

<p>Then <code>:arg1</code> is set to <code>&quot;foo&quot;</code>, and <code>:arg2</code> is set to <code>&quot;bar&quot;</code>.</p>

<p>Running the following:</p>

<pre class="code ruby"><code class="ruby">$ toys args-demo
</code></pre>

<p>Will produce a usage error, because no value is set for the required argument
<code>:arg1</code>. Similarly, running:</p>

<pre class="code ruby"><code class="ruby">$ toys args-demo foo bar baz
</code></pre>

<p>Will also produce an error, since the tool does not define an argument to
match <code>&quot;baz&quot;</code>.</p>

<p>Optional arguments may declare a default value to be used if the argument is
not provided on the command line. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>args-demo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:arg1</span>
  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:arg2</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>the-default</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>options data is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Now running the following:</p>

<pre class="code ruby"><code class="ruby">$ toys args-demo foo
Options data is {arg1: &quot;foo&quot;, arg2: &quot;the-default&quot;}
</code></pre>

<p>Will set the required argument to <code>&quot;foo&quot;</code> as usual, and the optional argument,
because it is not provided, will default to <code>&quot;the-default&quot;</code> instead of <code>nil</code>.</p>

<h4 id="remaining-arguments">Remaining arguments</h4>

<p>Normally, unmatched arguments will result in an error message. However, you can
provide an &quot;argument&quot; to match all <strong>remaining</strong> unmatched arguments at the
end, using the directive
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#remaining_args-instance_method">Toys::DSL::Tool#remaining_args</a>.
For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>args-demo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:arg1</span>
  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:arg2</span>
  <span class='id identifier rubyid_remaining_args'>remaining_args</span> <span class='symbol'>:arg3</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Options data is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_options'>options</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Now, we can see how the remaining arguments (if any) are collected by <code>:arg3</code>:</p>

<pre class="code ruby"><code class="ruby">$ toys args-demo foo bar baz qux
Options data is {arg1: &quot;foo&quot;, arg2: &quot;bar&quot;, arg3: [&quot;baz&quot;, &quot;qux&quot;]}

$ toys args-demo foo
Options data is {arg1: &quot;foo&quot;, arg2: nil, arg3: []}
</code></pre>

<p>Tools can include any number of <code>required_arg</code> and <code>optional_arg</code> directives,
declaring any number of required and optional arguments. But tools can have at
most only one <code>remaining_args</code> directive.</p>

<h4 id="descriptions-and-the-args-dsl">Descriptions and the args DSL</h4>

<p>Positional arguments may also have short and long descriptions, which are
displayed in online help. Set descriptions via the <code>desc:</code> and <code>long_desc:</code>
arguments to the argument directive. The <code>desc:</code> argument takes a single string
description, while the <code>long_desc:</code> argument takes an array of strings. Here is
an example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:arg</span><span class='comma'>,</span>
             <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This is a short description for the arg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
             <span class='label'>long_desc:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Long descriptions may have multiple lines.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This is the second line.</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
</code></pre>

<p>See the <a href="#Tool_descriptions">above section on Descriptions</a> for more
information on how descriptions are rendered and word wrapped.</p>

<p>Because long descriptions may be unwieldly to write as a hash argument in this
way, Toys provides an alternate syntax for defining arguments using a block.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:arg</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_desc'>desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This is a short description for the arg</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_long_desc'>long_desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Long desc can be set as multiple lines together,</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>like this second line.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_long_desc'>long_desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Or you can call long_desc again to add more lines.</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>For detailed info on configuring an argument using a block, see the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/PositionalArg">Toys::DSL::PositionalArg class</a>.</p>

<h4 id="argument-acceptors">Argument acceptors</h4>

<p>Finally, positional arguments may use <strong>acceptors</strong> to define how to validate
arguments and convert them to Ruby objects for your tool to consume. By
default, Toys will accept any argument string, and expose it to your tool as a
raw string. However, you may provide an acceptor to change this behavior.</p>

<p>Acceptors are part of the OptionParser interface, and are described under the
<a href="http://ruby-doc.org/stdlib/libdoc/optparse/rdoc/OptionParser.html#class-OptionParser-label-Type+Coercion">type coercion</a>
section. For example, you can provide the <code>Integer</code> class as an acceptor, which
will validate that the argument is a well-formed integer, and convert it to an
integer during parsing:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>acceptor-demo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:age</span><span class='comma'>,</span> <span class='label'>accept:</span> <span class='const'>Integer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Next year I will be </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_age'>age</span> <span class='op'>+</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>  <span class='comment'># Age is an integer
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If you pass a non-integer for this argument, Toys will report a usage error.</p>

<p>You may use any of the ready-to-use coercion types provided by OptionParser,
including the special types such as
<a href="http://ruby-doc.org/stdlib/libdoc/optparse/rdoc/OptionParser.html#DecimalInteger">OptionParser::DecimalInteger</a>
and
<a href="http://ruby-doc.org/stdlib/libdoc/optparse/rdoc/OptionParser.html#OctalInteger">OptionParser::OctalInteger</a>.</p>

<p>You may also create <strong>custom acceptors</strong>. See the
<a href="#Custom_acceptors">section below on Custom Acceptors</a> for more information.</p>

<h4 id="argument-completions">Argument completions</h4>

<p>Shell tab completion supports positional arguments, and arguments can be
configured to present a set of completion candidates for themselves.</p>

<p>By default, an argument does not provide any completions for itself. To change
that, set the <code>completion</code> option. Currently there are three ways to set the
completion:</p>

<ul>
<li>  Provide a static set of possible values, as an array of strings.</li>
<li>  Specify that values should be paths in the file system by setting the
symbol <code>:file_system</code>.</li>
<li>  Provide a <code>Proc</code> that returns possible values.</li>
</ul>

<p>The following are two example arguments, one that supports a static set of
completions and the other that supports file paths.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:language</span><span class='comma'>,</span> <span class='label'>complete:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>elixir</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rust</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_required_arg'>required_arg</span> <span class='symbol'>:path</span><span class='comma'>,</span> <span class='label'>complete:</span> <span class='symbol'>:file_system</span>
</code></pre>

<p>Completions are somewhat related to acceptors, and it is a common pattern to
set both in concert. But they perform distinct functions. Acceptors affect
argument parsing, whereas completions affect tab completion in the shell.</p>

<h3 id="flags">Flags</h3>

<p>Tools may also recognize <strong>flags</strong> on the command line. In our &quot;greet&quot; example,
we declared a flag named <code>:shout</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-s</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--shout</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Greet loudly.</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Like a positional argument, a flag sets an option based on the command line
arguments passed to the tool. In the case above, the <code>:shout</code> option is set to
<code>true</code> if either <code>-s</code> or <code>--shout</code> is provided on the command line; otherwise
it remains falsy. The two flags <code>-s</code> and <code>--shout</code> are effectively synonyms and
have the same effect. A flag declaration may include any number of synonyms.</p>

<p>As with arguments, Toys will provide a method that you can call to retrieve the
option value set by a flag. In this case, a method called <code>shout</code> will be
available, and will return either true or false. If the option name cannot be
made into a method, you can retrieve the value by calling
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#get-instance_method">Toys::Context#get</a>.</p>

<h4 id="flag-types">Flag types</h4>

<p>Toys recognizes the same syntax used by the standard OptionParser library. This
means you can also declare a flag that can be set either to true or false:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--[no-]shout</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>You can declare that a short or long flag takes a value:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--whom=VALUE</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--whom VALUE</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-wVALUE</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-w VALUE</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>You can also declare the value to be optional:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--whom[=VALUE]</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--whom [VALUE]</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-w[VALUE]</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-w [VALUE]</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Note that if you define multiple flags together, they will all be coerced to
the same &quot;type&quot;. That is, if one takes a value, they all will implicitly take
a value. (This is the same behavior as OptionParser.) In this example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-w</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--whom=VALUE</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>The <code>-w</code> flag will also implicitly take a value, because it is defined as a
synonym of another flag that takes a value.</p>

<p>Note also that Toys will raise an error if those flags are incompatible. For
example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-w[VALUE]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--whom=VALUE</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Raises an error because one flag&#39;s value is optional while the other is
required. (Again, this is consistent with OptionParser&#39;s behavior.)</p>

<h4 id="inferred-flags">Inferred flags</h4>

<p>If you do not provide any actual flags, Toys will attempt to infer one from the
name of the option. A one-character name will yield a short flag, and a longer
name a long flag. Hence, the following two definitions are equivalent:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--shout</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>And the following two are equivalent:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:S</span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:S</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-S</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Inferred flags will convert underscores to hyphens. So the following two
definitions are also equivalent:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:call_out</span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:call_out</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--call-out</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<h4 id="handling-optional-values">Handling optional values</h4>

<p>There are some subtleties in how the Ruby OptionParser library treats flags
with optional values. Although Toys does not use OptionParser interally, it
does, for the most part, replicate OptionParser&#39;s behavior. It is thus
important to understand that behavior if you use optional values.</p>

<p>First, if a flag has an optional value that is not provided on the command
line, then the option is set to <code>true</code>, as if it were a normal boolean flag
that didn&#39;t take a value. Consider this example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>flags-demo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:output</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--output [DIRECTORY]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>output is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_output'>output</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If a user executes this without passing the <code>--output</code> flag, the default will
be printed as we expect.</p>

<pre class="code ruby"><code class="ruby">$ toys flags-demo
output is &quot;.&quot;
</code></pre>

<p>If a user executes this and provides a value for <code>--output</code>, it will show up:</p>

<pre class="code ruby"><code class="ruby">$ toys flags-demo --output /etc
output is &quot;/etc&quot;
</code></pre>

<p>If a user provides <code>--output</code> but omits the value, it displays <code>true</code>:</p>

<pre class="code ruby"><code class="ruby">$ toys flags-demo --output
output is true
</code></pre>

<p>Second, if the following argument looks like a flag (i.e. it begins with a
hyphen), it is not treated as an optional value. In this example, the argument
<code>--verbose</code> is not treated as the value of <code>--output</code> but as a separate flag.
(If <code>--output</code> had a <em>required</em> value, then <code>--verbose</code> would have been treated
as the value.)</p>

<pre class="code ruby"><code class="ruby">$ toys flags-demo --output --verbose
output is true
</code></pre>

<p>Finally, there is an important difference between the syntax
<code>&quot;--output [DIRECTORY]&quot;</code> and <code>&quot;--output=[DIRECTORY]&quot;</code>. In the former case, the
following argument (as long as it doesn&#39;t look like a flag) will be treated as
the value. In the latter case, however, the following argument is <em>never</em>
treated as the value. In that latter case, you <em>must</em> use the equals sign
syntax to provide a value.</p>

<p>To illustrate, consider two flags with optional values, one using space and the
other using equals.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>flags-demo-space</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:output</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--output [DIRECTORY]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_set_remaining_args'>set_remaining_args</span> <span class='symbol'>:remaining</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>output is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_output'>output</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>flags-demo-equals</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:output</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--output=[DIRECTORY]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_set_remaining_args'>set_remaining_args</span> <span class='symbol'>:remaining</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>output is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_output'>output</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Here is the behavior:</p>

<pre class="code ruby"><code class="ruby">$ toys flags-demo-space --output=/etc
output is &quot;/etc&quot;
$ toys flags-demo-space --output /etc
output is &quot;/etc&quot;
$ toys flags-demo-equals --output=/etc
output is &quot;/etc&quot;
$ toys flags-demo-equals --output /etc
output is true
</code></pre>

<h4 id="flag-acceptors">Flag acceptors</h4>

<p>Flags may use <strong>acceptors</strong> to define how to validate values and convert them
to Ruby objects for your tool to consume. By default, Toys will accept a flag
value string in any form, and expose it to your tool as a raw string. However,
you may provide an acceptor to change this behavior.</p>

<p>Acceptors are part of the OptionParser interface, and are described under the
<a href="http://ruby-doc.org/stdlib/libdoc/optparse/rdoc/OptionParser.html#class-OptionParser-label-Type+Coercion">type coercion</a>
section. For example, you can provide the <code>Integer</code> class as an acceptor, which
will validate that the argument is a well-formed integer, and convert it to an
integer during parsing:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>flags-demo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:age</span><span class='comma'>,</span> <span class='label'>accept:</span> <span class='const'>Integer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Next year I will be </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_age'>age</span> <span class='op'>+</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>  <span class='comment'># Age is an integer
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If you pass a non-integer for this flag value, Toys will report a usage error.</p>

<p>You may use any of the ready-to-use coercion types provided by OptionParser,
including the special types such as
<a href="http://ruby-doc.org/stdlib/libdoc/optparse/rdoc/OptionParser.html#DecimalInteger">OptionParser::DecimalInteger</a>
and
<a href="http://ruby-doc.org/stdlib/libdoc/optparse/rdoc/OptionParser.html#OctalInteger">OptionParser::OctalInteger</a>.</p>

<p>You may also create <strong>custom acceptors</strong>. See the
<a href="#Custom_acceptors">section below on Custom Acceptors</a> for more information.</p>

<h4 id="defaults-and-handlers">Defaults and handlers</h4>

<p>Flags are usually optional; a flag can appear in a command line zero, one, or
any number of times.</p>

<p>If a flag is not passed in the command line arguments for a tool, by default
its corresponding option value will be <code>nil</code>. You may change this by providing
a default value for a flag:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:age</span><span class='comma'>,</span> <span class='label'>accept:</span> <span class='const'>Integer</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='int'>21</span>
</code></pre>

<p>If you pass a flag multiple times on the command line, by default the <em>last</em>
appearance of the flag will take effect. That is, suppose you define this flag:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--[no-]shout</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Now if you pass <code>--shout --no-shout</code>, then the value of the <code>:shout</code> option
will be <code>false</code>, i.e. the last value set on the command line. This is because a
flag normally <em>sets</em> its option value, replacing any previously set value.</p>

<p>You can, however, change this behavior by providing a <strong>handler</strong>. A handler is
a Ruby Proc that defines what a flag does to its option value. It takes two
arguments, the new value given, and the previously set value (which might be
the default value if this is the first appearance of the flag), and returns the
new value that should be set.</p>

<p>Effectively, the default behavior (setting the value and ignoring the previous
value) is equivalent to the following handler:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--[no-]shout</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>handler:</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='op'>|</span> <span class='id identifier rubyid_val'>val</span><span class='comma'>,</span> <span class='id identifier rubyid__prev'>_prev</span><span class='op'>|</span> <span class='id identifier rubyid_val'>val</span> <span class='rbrace'>}</span>
</code></pre>

<p>Toys gives the default handler the special name <code>:set</code>. So the above is also
equivalent to:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--[no-]shout</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>handler:</span> <span class='symbol'>:set</span>
</code></pre>

<p>The <code>--verbose</code> flag, provided automatically by Toys for most tools, shows an
example of an alternate handler. Verbosity is represented by an integer value,
defaulting to 0. The <code>--verbose</code> flag may appear any number of times, and
<em>each</em> appearance increases the verbosity. Its implementation is internal to
Toys, but looks something like this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='const'><span class='object_link'><a href="Toys.html" title="Toys (module)">Toys</a></span></span><span class='op'>::</span><span class='const'>Context</span><span class='op'>::</span><span class='const'>Key</span><span class='op'>::</span><span class='const'>VERBOSITY</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-v</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--verbose</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
     <span class='label'>default:</span> <span class='int'>0</span><span class='comma'>,</span>
     <span class='label'>handler:</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid__val'>_val</span><span class='comma'>,</span> <span class='id identifier rubyid_prev'>prev</span><span class='op'>|</span> <span class='id identifier rubyid_prev'>prev</span> <span class='op'>+</span> <span class='int'>1</span> <span class='rbrace'>}</span>
</code></pre>

<p>Similarly, the &quot;--quiet&quot; flag, which decreases the verbosity, is implemented
like this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='const'><span class='object_link'><a href="Toys.html" title="Toys (module)">Toys</a></span></span><span class='op'>::</span><span class='const'>Context</span><span class='op'>::</span><span class='const'>Key</span><span class='op'>::</span><span class='const'>VERBOSITY</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-q</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--quiet</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
     <span class='label'>default:</span> <span class='int'>0</span><span class='comma'>,</span>
     <span class='label'>handler:</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid__val'>_val</span><span class='comma'>,</span> <span class='id identifier rubyid_prev'>prev</span><span class='op'>|</span> <span class='id identifier rubyid_prev'>prev</span> <span class='op'>-</span> <span class='int'>1</span> <span class='rbrace'>}</span>
</code></pre>

<p>Note that both flags affect the same option name, <code>VERBOSITY</code>. The first
increments it each time it appears, and the second decrements it. A tool can
query this option and get an integer telling the requested verbosity level, as
you will see <a href="#Logging_and_verbosity">below</a>.</p>

<p>Toys provides a few built-in handlers that can be specified by name. We already
discussed the default handler that can be specified by its name <code>:set</code> or by
simply omitting the <code>handler:</code> option. Another named handler is <code>:push</code>. This
handler is intended for flags that take values and can be provided more than
once. The final value is then an array of values.</p>

<p>In the following example, an invocation can provide any number of <code>--include</code>
flags, and the <code>:include</code> option will be set to an array of the given paths.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:include</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-I</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--include PATH</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>handler:</span> <span class='symbol'>:push</span>
</code></pre>

<p>The <code>:push</code> handler is equivalent to
<code>proc { |val, array| array.nil? ? [val] : array &lt;&lt; val }</code>.</p>

<h4 id="descriptions-and-the-flags-dsl">Descriptions and the flags DSL</h4>

<p>Flags may also have short and long descriptions, which are displayed in online
help. Set descriptions via the <code>desc:</code> and <code>long_desc:</code> arguments to the flag
directive. The <code>desc:</code> argument takes a single string description, while the
<code>long_desc:</code> argument takes an array of strings. Here is an example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:my_flag</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--my-flag</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
     <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This is a short description for the arg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
     <span class='label'>long_desc:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Long descriptions may have multiple lines.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                 <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This is the second line.</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
</code></pre>

<p>See the <a href="#Tool_descriptions">above section on Descriptions</a> for more information on
how descriptions are rendered and word wrapped.</p>

<p>Because long descriptions may be unwieldly to write as a hash argument in this
way, Toys provides an alternate syntax for defining flags using a block.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:my_flag</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flags'>flags</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--my-flag</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_desc'>desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This is a short description for the flag</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_long_desc'>long_desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Long desc can be set as multiple lines together,</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>like this second line.</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_long_desc'>long_desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Or you can call long_desc again to add more lines.</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>For detailed info on configuring an flag using a block, see the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Flag">Toys::DSL::Flag class</a>.</p>

<h4 id="flag-completions">Flag completions</h4>

<p>Shell tab completion supports flag values, and flags can be configured to
present a set of completion candidates for themselves.</p>

<p>By default, a flag does not provide any completions for itself. To change that,
set the <code>completion</code> option. Currently there are three ways to set the
completion:</p>

<ul>
<li>  Provide a static set of possible values, as an array of strings.</li>
<li>  Specify that values should be paths in the file system by setting the
symbol <code>:file_system</code>.</li>
<li>  Provide a <code>Proc</code> that returns possible values.</li>
</ul>

<p>The following are two example flags, one that supports a static set of
completions and the other that supports file paths.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:language</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--lang=VAL</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>complete_values:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>elixir</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rust</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
<span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:path</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--path=VAL</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>complete_values:</span> <span class='symbol'>:file_system</span>
</code></pre>

<p>Completions are somewhat related to acceptors, and it is a common pattern to
set both in concert. But they perform distinct functions. Acceptors affect
option parsing, whereas completions affect tab completion in the shell.</p>

<h4 id="flag-groups">Flag groups</h4>

<p>Flags may be organized into groups. This serves two functions:</p>

<ul>
<li>  Grouping related flags in the help and usage screens</li>
<li>  Implementing required flags and other constraints</li>
</ul>

<p>To create a simple flag group, use the <code>flag_group</code> directive, and provide a
block that defines the group&#39;s flags. You may also provide a group description
that appears in the help screen.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag_group'>flag_group</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Debug flags</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:debug</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-D</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Enable debugger</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:warnings</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-W[VAL]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Enable warnings</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>Flag groups may have a &quot;type&quot; that specifies constraints on the flags contained
in the group. Flags in a simple group like the above are ordinary optional
flags. However, you may specify that flags in the group are required using the
<code>all_required</code> directive:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_all_required'>all_required</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Login flags (all required)</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:username</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--username=VAL</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Set the username (required)</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:password</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--password=VAL</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Set the password (required)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>If the tool is invoked without providing each of these required flags, it will
display an option parsing error.</p>

<p>The <code>all_required</code> directive is actually just shorthand for passing
<code>type: :required</code> to the <code>flag_group</code> directive. So the above is the same as:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_flag_group'>flag_group</span> <span class='label'>type:</span> <span class='symbol'>:required</span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Login flags (all required)</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:username</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--username=VAL</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Set the username (required)</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:password</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--password=VAL</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Set the password (required)</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>The following are the supported types of flag groups:</p>

<ul>
<li>  The <code>:required</code> type, which you can create using the directive
<code>all_required</code>. All flags from the group are required and must be provided
on the command line to avoid an error.</li>
<li>  The <code>:exactly_one</code> type, which you can create using the directive
<code>exactly_one_required</code>. Exactly one, and no more than one, flag from the
group must be provided on the command line to avoid an error.</li>
<li>  The <code>:at_most_one</code> type, which you can create using the directive
<code>at_most_one_required</code>. At most one flag from the group must be provided
on the command line to avoid an error.</li>
<li>  The <code>:at_least_one</code> type, which you can create using the directive
<code>at_least_one_required</code>. At least one flag from the group must be provided
on the command line to avoid an error.</li>
<li>  The <code>:optional</code> type is the default created using the directive
<code>flag_group</code> when no type is specified. Flags in the group are ordinary
optional flags.</li>
</ul>

<p>Flag group types are useful for a variety of tools. For example, suppose you
are writing a tool that deploys an app to one of several different kinds of
targets---say, a server, a VM, or a container. You could provide this
configuration for your tool with a flag group:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>deploy</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_exactly_one_required'>exactly_one_required</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Deployment targets</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:server</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--server=IP_ADDR</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:vm</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--vm=VM_ID</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:container</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--container=CONTAINER_ID</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># Now exactly one of server, vm, or container will be set. The other
</span>    <span class='comment'># two options will be their default value, nil.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="tool-execution-basics">Tool execution basics</h3>

<p>When you run a tool from the command line, Toys will build the tool based on
its definition in a Toys file, and then it will attempt to execute it by
calling the <code>run</code> method. Normally, you should define this method in each of
your tools.</p>

<p>Note: If you do not define the <code>run</code> method for a tool, Toys provides a default
implementation that displays the tool&#39;s help screen. This is typically used for
namespaces, as we shall see <a href="#Namespaces_and_subtools">below</a>. Most tools,
however, should define <code>run</code>.</p>

<p>Let&#39;s revisit the &quot;greet&quot; example we covered earlier.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-s</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--shout</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='id identifier rubyid_greeting'>greeting</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='kw'>if</span> <span class='id identifier rubyid_shout'>shout</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_greeting'>greeting</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Note that you can produce output or interact with the console using the normal
Ruby <code>$stdout</code>, <code>$stderr</code>, and <code>$stdin</code> streams.</p>

<p>Note also how the <code>run</code> method can access values that were assigned by flags or
positional arguments by just calling a method with that flag or argument name.
When you declare a flag or argument, if the option name is a symbol that is a
valid Ruby method name, Toys will provide a method that you can call to get the
value. In the above example, <code>whom</code> and <code>shout</code> are such methods.</p>

<p>If you create a flag or argument whose option name is not a symbol <em>or</em> is not
a valid method name, you can still get the value by calling the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#get-instance_method">Toys::Context#get</a>
method. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># The name &quot;whom-to-greet&quot; is not a valid method name.
</span>  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>whom-to-greet</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-s</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--shout</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># We can access the &quot;whom-to-greet&quot; option using the &quot;get&quot; method.
</span>    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>whom-to-greet</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='id identifier rubyid_greeting'>greeting</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='kw'>if</span> <span class='id identifier rubyid_shout'>shout</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_greeting'>greeting</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If a tool&#39;s <code>run</code> method finishes normally, Toys will exit with a result code
of 0, indicating success. You may exit immediately and/or provide a nonzero
result by calling the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#exit-instance_method">Toys::Context#exit</a>
method:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Exiting with an error...</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_exit'>exit</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Will never get here.</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>If your <code>run</code> method raises an exception, Toys will display the exception and
exit with a nonzero code.</p>

<p>Finally, you may also define additional methods within the tool. These are
available to be called by your <code>run</code> method, and can be used to decompose your
tool implementation. Indeed, a tool is actually a class under the hood, and
you can define methods as with any other class. Here&#39;s a contrived example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet-many</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># Support any number of arguments on the command line
</span>  <span class='id identifier rubyid_remaining_args'>remaining_args</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:shout</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-s</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--shout</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># You can define helper methods like this.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_greet'>greet</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='id identifier rubyid_greeting'>greeting</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span> <span class='kw'>if</span> <span class='id identifier rubyid_shout'>shout</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_greeting'>greeting</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_whom'>whom</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='op'>|</span>
      <span class='id identifier rubyid_greet'>greet</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>This should be enough to get you started implementing tools. A variety of
additional features are available for your tool implementation and will be
discussed further below. But first we will cover a few important topics.</p>

<h3 id="namespaces-and-subtools">Namespaces and subtools</h3>

<p>Like many command line frameworks, Toys supports <strong>subtools</strong>. You may, for
example create a tool called &quot;test&quot; that runs your tests for a particular
project, but you might also want &quot;test unit&quot; and &quot;test integration&quot; tools to
run specific subsets of the test suite. One way to do this, of course, is for
the &quot;test&quot; tool to parse &quot;unit&quot; or &quot;integration&quot; as arguments. However, it&#39;s
often easier to define them as separate tools, subtools of &quot;test&quot;.</p>

<p>To define a subtool, create nested <code>tool</code> directives. Here&#39;s a simple example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run unit tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run integration tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>You can now invoke them like this:</p>

<pre class="code ruby"><code class="ruby">$ toys test unit
run unit tests here...
$ toys test integration
run integration tests here...
</code></pre>

<p>Notice in this case, the parent &quot;test&quot; tool itself has no <code>run</code> method. This is
a common pattern: &quot;test&quot; is just a &quot;container&quot; for tools, a way of organizing
your tools. In Toys terminology, it is called a <strong>namespace</strong>. But it is still
a tool, and it can still be run:</p>

<pre class="code ruby"><code class="ruby">$ toys test
</code></pre>

<p>As discussed earlier, Toys provides a default implementation that displays the
help screen, which includes a list of the subtools and their descriptions.</p>

<p>As another example, the &quot;root&quot; tool is also normally a namespace. If you just
run Toys with no arguments:</p>

<pre class="code ruby"><code class="ruby">$ toys
</code></pre>

<p>The root tool will display the overall help screen for Toys.</p>

<p>Although it is a less common pattern, it is possible for a tool that has
subtools to have its own <code>run</code> method:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run all tests here...</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only unit tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only integration tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Now running <code>toys test</code> will run its own implementation.</p>

<p>(Yes, it is even possible to write a <code>run</code> method for the root tool. I don&#39;t
recommend doing so, because then you lose the root tool&#39;s useful default
implementation that lists all your tools.)</p>

<p>Toys allows subtools to be nested arbitrarily deep. In practice, however, more
than two or three levels of hierarchy can be confusing to use.</p>

<h2 id="understanding-toys-files">Understanding Toys files</h2>

<p>Toys commands are defined in Toys files. We covered the basic syntax for these
files in the <a href="#Defining_tools">above section on defining tools</a>. In this
section, we will take a deeper look at what you can do with Toys files.</p>

<h3 id="toys-directories">Toys directories</h3>

<p>So far we have been defining tools by writing a Toys file named <code>.toys.rb</code>
located in the current working directory. This works great if you have a small
number of fairly simple tools, but if you are defining many tools or tools with
long or complex implementations, you may find it better to split your tools in
separate files. You can have Toys load tools from multiple files by creating a
<strong>Toys directory</strong>.</p>

<p>A Toys directory is a directory called <code>.toys</code> located in the current working
directory. (Again, note the leading period.) Ruby files inside a Toys directory
(or any of its subdirectories) are loaded when Toys looks for tool definitions.
Furthermore, the name of the Ruby file (and indeed its path relative to the
Toys directory) determines which tool it defines.</p>

<p>For example, one way to create a &quot;greet&quot; tool, as we saw before, is to write a
<code>.toys.rb</code> file in the current directory, and populate it like this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>You could also create the same tool by creating a <code>.toys</code> directory, and then
creating a file <code>greet.rb</code> inside that directory.</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- greet.rb
</code></pre>

<p>The contents of <code>greet.rb</code> would be:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>Notice that we did not use a <code>tool &quot;greet&quot;</code> block here. That is because the
name of the file <code>greet.rb</code> already provides a naming context: Toys already
knows that we are defining a &quot;greet&quot; tool.</p>

<p>If you do include a <code>tool</code> block inside the <code>greet.rb</code> file, it will create a
<em>subtool</em> of <code>greet</code>. In other words, the path to the Ruby file defines a
&quot;starting point&quot; for the names of tools defined in that file.</p>

<p>If you create subdirectories inside a Toys directory, their names also
contribute to the namespace of created tools. For example, if you create a
directory <code>.toys/test</code> and a file <code>unit.rb</code> under that directory, it will
create the tool <code>test unit</code>.</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- greet.rb   &lt;-- defines &quot;greet&quot; (and subtools)
   |
   +- test/
      |
      +- unit.rb   &lt;-- defines &quot;test unit&quot; (and its subtools)
</code></pre>

<p>Once again, <code>test unit</code> is the &quot;starting point&quot; for tools defined in the
<code>.toys/test/unit.rb</code> file. Declarations and methods at the top level of that
file will define the <code>test unit</code> tool. Any <code>tool</code> blocks you add to that file
will define subtools of <code>test unit</code>.</p>

<h4 id="index-files">Index files</h4>

<p>The file name <code>.toys.rb</code> can also be used inside Toys directories and
subdirectories. Such files are called <strong>index files</strong>, and they create tools
with the <em>directory</em> as the &quot;starting point&quot; namespace. For example, if you
create an index file directly underneath a <code>.toys</code> directory, it will define
top level tools (just like a <code>.toys.rb</code> file in the current directory.) An
index file located inside <code>.toys/test</code> will define tools with <code>test</code> as the
&quot;starting point&quot; namespace.</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- .toys.rb   &lt;-- index file, defines tools at the top level
   |
   +- greet.rb   &lt;-- defines &quot;greet&quot; (and subtools)
   |
   +- test/
      |
      +- .toys.rb   &lt;-- index file, defines &quot;test&quot; (and its subtools)
      |
      +- unit.rb   &lt;-- defines &quot;test unit&quot; (and its subtools)
</code></pre>

<p>Index files give you some flexibility for organizing your tools. For example,
if you have a number of subtools of <code>test</code>, including a lot of small tools and
one big complex subtool called <code>unit</code>, you might define all the simple tools in
the index file <code>.toys/test/.toys.rb</code>, while defining the large <code>test unit</code> tool
in the separate file <code>.toys/test/unit.rb</code>.</p>

<p>Toys also loads index files first before other files in the directory. This
means they are convenient places to define shared code that can be used by all
the subtools defined in that directory, as we shall see later in the
<a href="#Sharing_code">section on sharing code</a>.</p>

<h3 id="the-toys-search-path">The Toys search path</h3>

<p>So far we have seen how to define tools by writing a <code>.toys.rb</code> file in the
current directory, or by writing files inside a <code>.toys</code> directory in the
current directory. These tools are &quot;scoped&quot; to the current directory. If you
move to a different directory, they may not be available.</p>

<p>When Toys runs, it looks for tools in a <strong>search path</strong>. Specifically:</p>

<ol>
<li> It looks for a <code>.toys.rb</code> file and/or a <code>.toys</code> directory in the <em>current
working directory</em>.</li>
<li> It does the same in the <em>parent directory</em> of the current directory, and
then its parent, and so on until it hits either the root of the file system
or one of the global directories described in (3).</li>
<li> It looks in a list of <em>global directories</em>, specified in the environment
variable <code>TOYS_PATH</code>. This variable can contain a colon-delimited list of
directory paths. If the variable is not set, the current user&#39;s <em>home
directory</em>, and the system configuration directory (<code>/etc</code> on unix systems)
are used by default. Toys does <em>not</em> search parents of global directories.</li>
</ol>

<p>It uses the <em>first</em> implementation that it finds for the requested tool. For
example, if the tool <code>greet</code> is defined in the <code>.toys.rb</code> file in the current
working directory, and also in the <code>.toys/greet.rb</code> file of the parent
directory, it will use the version in the current directory.</p>

<p>This means you could write a default implementation for a tool in your home
directory, and override it in the current directory. For example, you could
define a tool <code>get-credentials</code> in your home directory that gets credentials
you need for <em>most</em> of your projects. But maybe on particular project requires
different credentials, so you could define a different <code>get-credentials</code> tool
in that project&#39;s directory.</p>

<p>While a tool can be overridden when it is defined at different points in the
search path, it is <em>not</em> allowed to provide multiple definitions of a tool at
the <em>same</em> point in the search path. For example, if you define the <code>greet</code>
tool twice in the same <code>.toys.rb</code> file, Toys will report an error. Perhaps less
obviously, if you define <code>greet</code> in the <code>.toys.rb</code> file in the current
directory, and you also define it in the <code>.toys/greet.rb</code> file in the same
current directory, Toys will also report an error, since both are defined at
the same point (the current directory) in the search path.</p>

<p>Note that in the search path above, steps (1) and (2) are <em>context-dependent</em>.
That is, they may be different depending on what directory you are in. However,
step (3) is <em>not</em> context-dependent, and is searched regardless of where you
are located. Tools defined here are <strong>global</strong>, available everywhere.</p>

<h2 id="the-execution-environment">The execution environment</h2>

<p>This section describes the context and resources available to your tool when it
is running; that is, what you can call from your tool&#39;s <code>run</code> method.</p>

<p>Each tool is defined as a class that subclasses
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context">Toys::Context</a>. The base
class defines a number of methods, and provides access to a variety of data and
objects relevant to your tool. We have already seen earlier how to use the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#get-instance_method">Toys::Context#get</a>
method to retrieve option values, and how to use the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#exit-instance_method">Toys::Context#exit</a>
method to exit immediately and return an exit code. Now we will cover other
resources available to your tool.</p>

<h3 id="built-in-context">Built-in context</h3>

<p>In addition to the options set by your tool&#39;s flags and command line arguments,
a variety of other data and objects are also accessible using the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#get-instance_method">Toys::Context#get method</a>
For example, you can get the full name of the tool being executed like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Current tool is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='const'>TOOL_NAME</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>TOOL_NAME</code> constant above is a well-known key that corresponds to the full
name (as an array of strings) of the running tool. A variety of well-known keys
are defined in the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context/Key">Toys::Context::Key module</a>.
They include information about the current execution, such as the tool name and
the original command line arguments passed to it (before they were parsed).
They also include some internal Toys objects, which can be used to do things
like write to the logger or look up and call other tools.</p>

<p>Most of the important context also can be accessed from convenience methods.
For example, the <code>TOOL_NAME</code> is also available from the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#tool_name-instance_method">Toys::Context#tool_name method</a>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Current tool is </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_tool_name'>tool_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>Let&#39;s take a look at a few things your tool can do with the objects you can
access from built-in context.</p>

<h3 id="logging-and-verbosity">Logging and verbosity</h3>

<p>Toys provides a Logger (a simple instance of the Ruby standard library logger
that writes to standard error) for your tool to use to report status
information. You can access this logger via the <code>LOGGER</code> context key, or the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#logger-instance_method">Toys::Context#logger method</a>.
For example:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Danger Will Robinson!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>The current logger level is controlled by the verbosity. Verbosity is an
integer context value that you can retrieve using the <code>VERBOSITY</code> context key
or the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#verbosity-instance_method">Toys::Context#verbosity method</a>.
The verbosity is set to 0 by default. This corresponds to a logger level of
<code>WARN</code>. That is, warnings, errors, and fatals are displayed, while infos and
debugs are not. However, <a href="#Standard_flags">as we saw earlier</a>, most tools
automatically respond to the <code>--verbose</code> and <code>--quiet</code> flags, (or <code>-v</code> and
<code>-q</code>), which increment and decrement the verbosity value, respectively. If you
run a tool with <code>-v</code>, the verbosity is incremented to 1, and the logger level
is set to <code>INFO</code>. If you set <code>-q</code>, the verbosity is decremented to -1, and the
logger level is set to <code>ERROR</code>. So by using the provided logger, a tool can
easily provide command line based control of the output verbosity.</p>

<h3 id="running-tools-from-tools">Running tools from tools</h3>

<p>A common operation a tool might want to do is &quot;call&quot; another tool. This can be
done via the CLI object, which you can retrieve using the <code>CLI</code> key or the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#cli-instance_method">Toys::Context#cli method</a>.
These return the current instance of
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/CLI">Toys::CLI</a> which is the
&quot;main&quot; interface to Toys. In particular, it provides the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/CLI#run-instance_method">Toys::CLI#run method</a>
which can be used to call another tool:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_cli'>cli</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rubyists</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-v</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_exit'>exit</span><span class='lparen'>(</span><span class='id identifier rubyid_status'>status</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span>
<span class='kw'>end</span>
</code></pre>

<p>Pass the tool name and arguments as arguments to the run method. It will
execute, and return a process status code (i.e. 0 for success, and nonzero for
error). Make sure you handle the exit status. For example, in most cases, you
should probably exit if the tool you are calling returns a nonzero code.</p>

<p>You may also use the <code>exec</code> mixin <a href="#Executing_subprocesses">described below</a> to
run a tool in a separate process. This is particularly useful if you need to
capture or manipulate that tool&#39;s input or output stream.</p>

<h3 id="helper-methods-and-mixins">Helper methods and mixins</h3>

<p>The methods of <a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context">Toys::Context</a>
are not the only methods available for your tool to call. We
<a href="#Tool_execution_basics">saw earlier</a> that a tool can define additional methods
that you can use as helpers.</p>

<p>You can also include <strong>mixins</strong>, which are modules that bring in a whole set of
helper methods. Include a mixin using the <code>include</code> directive:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:terminal</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This is a bold line.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:bold</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>A mixin may be specified by providing a module itself, or by providing a
<strong>mixin name</strong>. In the above example, we used <code>:terminal</code>, which is the name
of a built-in mixin that Toys provides. Among other things, it defines a
special <code>puts</code> method that lets you include style information such as <code>:bold</code>,
which affects the display on ANSI-capable terminals.</p>

<p>For details on the built-in mixins provided by Toys, see the modules under
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/StandardMixins">Toys::StandardMixins</a>.
We will look at a few examples of the use of these mixins below. Built-in
mixins have names that are symbols.</p>

<p>You can also define your own mixins, as we will see in the
<a href="#Defining_mixins">upcoming section on defining mixins</a>.</p>

<h3 id="executing-subprocesses">Executing subprocesses</h3>

<p>Another common operation you might do in a tool is to execute other binaries.
For example, you might write a tool that shells out to <code>scp</code> to copy files to
a remote server.</p>

<p>Ruby itself provides a few convenient methods for simple execution, such as the
<a href="http://ruby-doc.org/core/Kernel.html#method-i-system">Kernel#system</a> method.
However, these typically provide limited ability to control or interact with
subprocess streams, and you also need to remember to handle the exit status
yourself. If you do want to exert more control over subprocesses, you can use
<a href="http://ruby-doc.org/core/Process.html#method-c-spawn">Process.spawn</a>, or a
higher-level wrapper such as the
<a href="http://ruby-doc.org/stdlib/libdoc/open3/rdoc/index.html">open3 library</a>.</p>

<p>Another alternative is to use the <code>:exec</code> built-in mixin. This mixin provides
convenient methods for the common cases of executing subprocesses and capturing
their output, and a powerful block-based interface for controlling streams. The
exec mixin also lets you set a useful default option that causes the tool to
exit automatically if one of its subprocesses exits abnormally.</p>

<p>The exec mixin provides methods for running several different kinds of
subprocesses:</p>

<ul>
<li>  Normal processes started by the operating system.</li>
<li>  Another Ruby process.</li>
<li>  A shell script.</li>
<li>  Another tool run in a separate (forked) process.</li>
<li>  A block run in a separate (forked) process.</li>
</ul>

<p>For more information, see the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/StandardMixins/Exec">Toys::StandardMixins::Exec mixin module</a>
and the underyling library
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Utils/Exec">Toys::Utils::Exec</a>.</p>

<h3 id="formatting-output">Formatting output</h3>

<p>Interacting with the user is a very common function of a command line tool, and
many modern tools include intricately designed and styled output, and terminal
effects such as progress bars and spinners. Toys provides several mixins that
can help create nicer interfaces.</p>

<p>First, there is <code>:terminal</code>, which provides some basic terminal features such
as styled output and simple spinners. For information, see the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/StandardMixins/Terminal">Toys::StandardMixins::Terminal mixin module</a>
and the underyling library
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Terminal">Toys::Terminal</a>.</p>

<p>If you prefer the venerable Highline library interface, Toys provides a mixin
called <code>:highline</code> that automatically installs the highline gem (version 2.x)
if it is not available, and makes a highline object available to the tool. For
more information, see the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/StandardMixins/Highline">Toys::StandardMixins::Highline mixin module</a>.</p>

<p>You may also use other third-party gems such as
<a href="https://github.com/piotrmurach/tty">tty</a>. The section below on
<a href="#Useful_gems">useful gems</a> provides some examples.</p>

<h2 id="sharing-code">Sharing code</h2>

<p>As you accumulate additional and more complex tools, you may find that some of
your tools need to share some common configuration, data, or logic. You might,
for example, have a set of admin scripts that need to do some common
authentication. This section describes several techniques for sharing code
between tools, and describes the scope of Ruby structures, such as methods,
classes, and constants, that you might define in your tools.</p>

<h3 id="defining-mixins">Defining mixins</h3>

<p>We <a href="#Helper_methods_and_mixins">saw earlier</a> that you can mix a module (with
all its methods) into your tool using the <code>include</code> directive. You can specify
a module itself, or the name of a built-in mixin such as <code>:exec</code> or
<code>:terminal</code>. But you can also define your own mixin using the <code>mixin</code>
directive. A mixin defined in a tool can be <code>include</code>d in that tool or any of
its subtools or their subtools, recursively, so it&#39;s a useful way to share
code. Here&#39;s how that works.</p>

<p>Define a mixin using the <code>mixin</code> directive, and give it a name and a block. The
mixin name must be a string. (Symbols are reserved for built-in mixins.) In the
block, you can define methods that will be made available to any tool that
includes the mixin, in the same way that you can include a Ruby module.</p>

<p>(Note that, unlike full modules, mixins allow only methods to be shared. Mixins
do not support constants. See the next section on
<a href="#Using_constants">using constants</a> to learn how Toys handles constants.)</p>

<p>Here&#39;s an example. Suppose you had common setup code that you wanted to share
among your testing tools.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># Define a mixin, which is just a collection of methods.
</span>  <span class='id identifier rubyid_mixin'>mixin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>common_test_code</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_setup'>setup</span>
      <span class='comment'># Do setup here
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># Include the mixin by name
</span>    <span class='id identifier rubyid_include'>include</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>common_test_code</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_setup'>setup</span>  <span class='comment'># Mixin methods are made available
</span>      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only unit tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_include'>include</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>common_test_code</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_setup'>setup</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only integration tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>A mixin is available to the tool in which it is defined, and any subtools and
descendants defined at the same point in the Toys search path, but not from
tools defined in a different point in the search path. For example, if you
define a mixin in a file located in a <code>.toys</code> directory, it will be visible to
descendant tools defined in that same directory, but not in a different <code>.toys</code>
directory.</p>

<p>A common technique, for example, would be to define a mixin in the
<a href="#Index_files">index file</a> in a Toys directory. You can then include it from
any subtools defined in other files in that same directory.</p>

<h4 id="mixin-initializers">Mixin initializers</h4>

<p>Sometimes a mixin will want to initialize some state before the tool executes.
For example, the <code>:highline</code> mixin creates an instance of Highline during tool
initialization. To do so, provide an <code>on_initialize</code> block in the mixin block.
The initializer block is called within the context of the tool after arguments
are parsed, so it has access to the tool&#39;s built-in context and options.</p>

<p>If you provide extra arguments when you <code>include</code> a mixin, those are passed to
the initializer block.</p>

<p>For example, suppose the <code>&quot;common_test_code&quot;</code> mixin needs to behave differently
depending on the type of tests (unit vs integration). Let&#39;s have the subtools
pass a value to the mixin&#39;s initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_mixin'>mixin</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>common_test_code</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># Initialize the mixin, and receive the argument passed to the
</span>    <span class='comment'># include directive
</span>    <span class='id identifier rubyid_on_initialize'>on_initialize</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_type'>type</span><span class='op'>|</span>
      <span class='comment'># Initializers are called in the context of the tool, and so can
</span>      <span class='comment'># affect the tool&#39;s state.
</span>      <span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='symbol'>:test_type</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_setup'>setup</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Setting up </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='symbol'>:test_type</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># Pass an extra argument to include
</span>    <span class='id identifier rubyid_include'>include</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>common_test_code</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_setup'>setup</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only unit tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_include'>include</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>common_test_code</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_setup'>setup</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only integration tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h4 id="mixin-inclusion-hooks">Mixin inclusion hooks</h4>

<p>A mixin can also optionally provide directives to run when the mixin is
included, by defining an <code>on_include</code> block. (This is functionally similar to
defining an <code>included</code> method on a Ruby module.) The <code>on_include</code> block is
called within the context of the tool DSL, so it can invoke any DSL directives.</p>

<p>If you provide extra arguments when you <code>include</code> a mixin, those are passed to
the inclusion block.</p>

<h3 id="using-constants">Using constants</h3>

<p>You can define and use Ruby constants, i.e. names beginning with a capital
letter, in a Toys file. However, they are subject to Ruby&#39;s rules regarding
constant scope and lookup, which can be confusing, especially in a DSL. Toys
tries to simplify those rules and make constant behavior somewhat tractable,
but if you do use constants (which includes modules and classes defined in a
Toys file), it is important to understand how they work.</p>

<p>Constants in Toys are visible only within the Toys file in which they are
defined. They normally behave as though they are defined at the &quot;top level&quot; of
the file. Even if you define a constant lexically &quot;inside&quot; a tool or a mixin,
the constant does <em>not</em> end up connected to that tool or mixin; it is defined
at the file level.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># This constant is now usable for the rest of the file
</span>    <span class='const'>API_KEY_FOR_TESTING</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>12345</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='comment'># It is visible here
</span>      <span class='id identifier rubyid_puts'>puts</span> <span class='const'>API_KEY_FOR_TESTING</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='comment'># And it is still visible here
</span>      <span class='id identifier rubyid_puts'>puts</span> <span class='const'>API_KEY_FOR_TESTING</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>(Note it is still possible to attach constants to a tool or mixin by defining
them with <code>self::</code>. However, this is uncommon Ruby practice and is mildly
discouraged.)</p>

<p>Because of this, it is highly recommended that you define constants only at the
top level of a Toys file, so it doesn&#39;t &quot;look&quot; like it is scoped to something
smaller. In particular, do not attempt to define constants in a mixin, unless
you scope them with <code>self::</code>.</p>

<p>Modules and classes defined using the <code>module</code> or <code>class</code> keyword, are also
constants, and thus follow the same rules. So you could, for example, define a
&quot;mixin&quot; module like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>CommonTestCode</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="Toys.html" title="Toys (module)">Toys</a></span></span><span class='op'>::</span><span class='const'>Mixin</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_setup'>setup</span>
    <span class='comment'># Do setup here
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># Include the modules as a mixin
</span>    <span class='id identifier rubyid_include'>include</span> <span class='const'>CommonTestCode</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_setup'>setup</span>  <span class='comment'># Module methods are made available
</span>      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only unit tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='id identifier rubyid_include'>include</span> <span class='const'>CommonTestCode</span>
    <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
      <span class='id identifier rubyid_setup'>setup</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>run only integration tests here...</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>The difference between this technique and using the <code>mixin</code> directive we saw
earlier, is the scope. The module here is accessed via a constant, and so, like
any constant, it is visible only in the same file it is defined in. The <code>mixin</code>
directive creates mixins that are visible from <em>all</em> files at the same point in
the search path.</p>

<p>Not also, when you define a mixin in this way, you should include <code>Toys::Mixin</code>
in the module, as illustrated above. This makes <code>on_initialize</code> available in
the module.</p>

<h3 id="templates">Templates</h3>

<p>Another way to share code is to expand a <strong>template</strong>.</p>

<p>A template is a class that inserts a bunch of lines into a Toys file. It is
often used to &quot;instantiate&quot; prefabricated tools. For instance, Toys comes with
a template called &quot;minitest&quot; that can generate a test tool for you. You
instantiate it using the <code>expand</code> directive in your Toys file, like this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:minitest</span>
</code></pre>

<p>And it will generate a tool called &quot;test&quot; that runs your test suite.</p>

<p>Most templates generate one or more complete tools. However, it is possible for
a template to generate just part of a tool, such as one or more description
directives. In general, expanding a template simply adds directives to your
Toys file.</p>

<p>Many templates can be configured with options such as the name of the tool to
generate, or details of the tool&#39;s behavior. This is done by passing additional
arguments to the <code>expand</code> directive, such as:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:minitest</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit-test</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>warnings:</span> <span class='kw'>true</span>
</code></pre>

<p>Alternatively, you may provide a block to <code>expand</code>. It will yield the template
to your block, letting you modify its properties:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:minitest</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit-test</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_warnings'>warnings</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span>
</code></pre>

<p>Toys provides several built-in templates that are useful for project and gem
development, including templates that generate build, test, and documentation
tools. The <code>:minitest</code> template illustrated above is one of these built-in
templates. Like built-in mixins, built-in template names are always symbols.
You can read more about them in the next section on using
<a href="#Toys_as_a_Rake_replacement">Toys as a Rake replacement</a>.</p>

<p>You may also write your own templates. Here&#39;s how...</p>

<h4 id="defining-templates">Defining templates</h4>

<p>One way to define a template is to use the <code>template</code> directive. Like the
<code>mixin</code> directive, this creates a named template that you can access inside the
current tool and any of its subtools. Also, like mixins, your template name
must be a string.</p>

<p>Following is a simple template example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_template'>template</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>whom:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='ivar'>@name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>
    <span class='ivar'>@whom</span> <span class='op'>=</span> <span class='id identifier rubyid_whom'>whom</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:name</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:whom</span>

  <span class='id identifier rubyid_on_expand'>on_expand</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_template'>template</span><span class='op'>|</span>
    <span class='id identifier rubyid_tool'>tool</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_desc'>desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A greeting tool generated from a template</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_to_run'>to_run</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_expand'>expand</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_expand'>expand</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet-ruby</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>whom:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Above we created a template called &quot;greet&quot;. A template is simply a class. It
will typically have a constructor, and methods to access configuration
properties. When the template is expanded, the class gets instantiated, and you
can set those properties.</p>

<p>Next, a template has an <code>on_expand</code> block. This block contains the Toys file
directives that should be generated by the template. The template object is
passed to the block, so it can access the template configuration when
generating directives. The &quot;greet&quot; template in the above example generates a
tool whose name is set by the template&#39;s <code>name</code> property.</p>

<p>Notice that in the above example, we used <code>to_run do</code>, providing a <em>block</em> for
the tool&#39;s execution, rather than <code>def run</code>, providing a method. Both forms are
valid and will work in a template (as well as in a normal Toys file), but the
block form is often useful in a template because you can access the <code>template</code>
variable inside the block, whereas it would not be accessible if you defined a
method. Similarly, if your template generates helper methods, and the body of
those methods need access to the <code>template</code> variable, you can use
<a href="http://ruby-doc.org/core/Module.html#method-i-define_method">Module#define_method</a>
instead of <code>def</code>.</p>

<p>By convention, it is a good idea for configuration options for your template to
be settable <em>both</em> as arguments to the constructor, <em>and</em> as <code>attr_accessor</code>
properties. In this way, when you expand the template, options can be provided
either as arguments to the <code>expand</code> directive, or in a block passed to the
directive by setting properties on the template object.</p>

<h4 id="template-classes">Template classes</h4>

<p>Finally, templates are classes, and you can create a template directly as a
class by including the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Template">Toys::Template</a> module
in your class definition.</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>GreetTemplate</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="Toys.html" title="Toys (module)">Toys</a></span></span><span class='op'>::</span><span class='const'>Template</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>whom:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='ivar'>@name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>
    <span class='ivar'>@whom</span> <span class='op'>=</span> <span class='id identifier rubyid_whom'>whom</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:name</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:whom</span>

  <span class='id identifier rubyid_on_expand'>on_expand</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_template'>template</span><span class='op'>|</span>
    <span class='id identifier rubyid_tool'>tool</span> <span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_desc'>desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A greeting tool generated from a template</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_to_run'>to_run</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_template'>template</span><span class='period'>.</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_expand'>expand</span> <span class='const'>GreetTemplate</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet-ruby</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>whom:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Remember that classes created this way are constants, and so the name
<code>GreetTemplate</code> is available only inside the Toys file where it was defined.</p>

<p>You must <code>include Toys::Template</code> if you define a template directly as a class,
but you can omit it if you use the <code>template</code> directive to define the template
in a block.</p>

<p>Defining templates as classes is also a useful way for third-party gems to
provide Toys integration. For example, suppose you are writing a code analysis
gem, and you want to make it easy for your users to create a Toys tool that
invokes your analysis. Just write a template class in your gem, maybe named
<code>MyAnalysis::ToysTemplate</code>. Now, just instruct your users to include the
following in their Toys file:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my_analysis</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_expand'>expand</span> <span class='const'>MyAnalysis</span><span class='op'>::</span><span class='const'>ToysTemplate</span>
</code></pre>

<h3 id="loading-from-a-lib-directory">Loading from a lib directory</h3>

<p>For more complicated tools, you might want to write normal Ruby modules and
classes as helpers. Toys provides a way to write Ruby code outside of its DSL
and <code>require</code> the code from your tool, using <code>.lib</code> directories.</p>

<p>To use <code>.lib</code> directories, you must define your tools inside a
<a href="#Toys_directories">Toys directory</a>. When a tool is executed, it looks for
directories called <code>.lib</code> in the Toys directory, and adds them to the Ruby load
path. Your tool can thus call <code>require</code> to load helpers from any Ruby files in
a <code>.lib</code> directory.</p>

<p>For example, take the following directory structure:</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- .lib/   &lt;-- available when a tool is executed
   |  |
   |  +- greeting_helper.rb
   |
   +- greet.rb
</code></pre>

<p>The <code>greeting_helper.rb</code> file can contain any Ruby code.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># .toys/.lib/greeting_helper.rb
</span>
<span class='kw'>module</span> <span class='const'>GreetingHelper</span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_make_greeting'>make_greeting</span><span class='lparen'>(</span><span class='id identifier rubyid_whom'>whom</span><span class='rparen'>)</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Now you can <code>require &quot;greeting_helper&quot;</code> in your <code>greet</code> tool.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># .toys/greet.rb
</span>
<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Whom to greet.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greeting_helper</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='const'>GreetingHelper</span><span class='period'>.</span><span class='id identifier rubyid_make_greeting'>make_greeting</span><span class='lparen'>(</span><span class='id identifier rubyid_whom'>whom</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Note that <code>.lib</code> directories are available only when your tool is being <em>run</em>,
not when it is being defined. So any <code>require</code> statements should be located
<em>inside</em> your <code>run</code> method.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greet</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># Do not try to require the file here. Toys will not find it because
</span>  <span class='comment'># the tool is not yet being run.
</span>  <span class='comment'># require &quot;greeting_helper&quot;  # ERRORS!
</span>
  <span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Whom to greet.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># Require a helper file here, so it is loaded during tool execution.
</span>    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greeting_helper</span><span class='tstring_end'>&quot;</span></span>
    <span class='comment'># Now you can use classes defined in the helper
</span>    <span class='id identifier rubyid_puts'>puts</span> <span class='const'>GreetingHelper</span><span class='period'>.</span><span class='id identifier rubyid_make_greeting'>make_greeting</span><span class='lparen'>(</span><span class='id identifier rubyid_whom'>whom</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If your Toys directory has subdirectories, lib directories will be prioritized
by how close they are to the tool being executed. For example:</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- .lib/   &lt;-- available when any tool defined in this directory
   |  |           is executed
   |  |
   |  +- helper.rb   &lt;-- visible to &quot;greet&quot; but not &quot;test unit&quot;
   |  |
   |  +- helper2.rb   &lt;-- visible to both &quot;greet&quot; and &quot;test unit&quot;
   |
   +- greet.rb
   |
   +- test/
      |
      +- .lib/   &lt;-- available only when tools under &quot;test&quot; are executed
      |  |
      |  +- helper.rb   &lt;-- overrides the other helper.rb when
      |                     &quot;test unit&quot; is executed
      |
      +- unit.rb
</code></pre>

<h3 id="preloading-ruby-files">Preloading Ruby files</h3>

<p>You may also provide Ruby files that are &quot;preloaded&quot; before tools are defined.
This is useful if those Ruby files are required by the tool definitions
themselves. Like files in the <code>.lib</code> directory, preloaded files can define Ruby
classes, modules, and other code. But preloaded files <em>automatically</em> loaded
(i.e. you do not <code>require</code> them explicitly) <em>before</em> your tools are defined.</p>

<p>To use preloaded files, you must define your tools inside a
<a href="#Toys_directories">Toys directory</a>. Before any tools inside a directory are
loaded, any file named <code>.preload.rb</code> in the directory is automatically
required. Additionally, any Ruby files inside a subdirectory called <code>.preload</code>
are also automatically required.</p>

<p>For example, take the following directory structure:</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- .preload.rb   &lt;-- required first
   |
   +- greet.rb   &lt;-- defines &quot;greet&quot; (and subtools)
   |
   +- test/
      |
      +- .preload/
      |  |
      |  +- my_classes.rb  &lt;-- required before unit.rb
      |  |
      |  +- my_modules.rb  &lt;-- also required before unit.rb
      |
      +- unit.rb   &lt;-- defines &quot;test unit&quot; (and its subtools)
</code></pre>

<p>Toys will execute</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.toys/.preload.rb</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>first before loading any of the tools in the <code>.toys</code> directory (or any of its
subdirectories). Thus, you can define classes used by both the <code>greet</code> and the
<code>test unit</code> tool in this file.</p>

<p>Furthermore, Toys will also execute</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.toys/test/.preload/my_classes.rb</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.toys/test/.preload/my_modules.rb</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>first before loading any of the tools in the <code>test</code> subdirectory. Thus, any
additional classes needed by <code>test unit</code> can be defined in these files.</p>

<p>Either a single <code>.preload.rb</code> file or a <code>.preload</code> directory, or both, may be
used. If both are present in the same directory, the <code>.preload.rb</code> file is
loaded first before the <code>.preload</code> directory contents.</p>

<h2 id="using-third-party-gems">Using third-party gems</h2>

<p>The toys executable itself uses only two gems: <strong>toys</strong> and <strong>toys-core</strong>. It
has no other gem dependencies. However, the Ruby community has developed many
resources for building command line tools, including a variety of gems that
provide alternate command line parsing, control of the ANSI terminal, formatted
output such as trees and tables, and effects such as hidden input, progress
bars, various ways to spawn and control subprocesses, and so forth. You may
find some of these gems useful when writing your tools. Additionally, if you
are using Toys for your project&#39;s build scripts, it might be necessary to
install your bundle when running some tools.</p>

<p>This section describes how to manage and use external gems with Toys. Note that
running Toys with <code>bundle exec</code> is generally <em>not</em> recommended. We&#39;ll discuss
the reasons for this, and what you can do instead.</p>

<h3 id="why-not-bundle-exec-toys">Why not &quot;bundle exec toys&quot;</h3>

<p><a href="https://bundler.io">Bundler</a> is often used when a command-line program depends
on external gems. You specify the gem dependencies in a <code>Gemfile</code>, use bundler
to resolve and install those dependencies, and then run the program prefixed by
<code>bundle exec</code> to ensure those dependencies are in the Ruby load path. When
running a Rake task, for example, it is almost automatic for many Ruby
developers to run <code>bundle exec rake my-task</code>.</p>

<p>So why not simply run <code>bundle exec toys my-tool</code>?</p>

<p>In simple cases, this will work just fine. However, Toys is a much more
flexible tool than Rake, and it covers two cases that are not well served by
<code>bundle exec</code>.</p>

<p>First, Toys lets you define <em>global tools</em> that are defined in your home
directory or system config directory. (See the previous section on
<a href="#The_Toys_search_path">the Toys search path</a>.) These tools are global, and can
be called from anywhere. But if they have gem dependencies, it might not be
feasible for their Gemfiles to be present in every directory from which you
might want to run them.</p>

<p>Second, it&#39;s possible for a variety of tools to be available together,
including both locally and globally defined, with potentially different sets of
dependencies. With <code>bundle exec</code>, you must choose beforehand which bundle to
use.</p>

<p>Although traditional <code>bundle exec</code> doesn&#39;t always work, Toys provides ways for
individual tools to manage their own gem dependencies.</p>

<h3 id="using-bundler-with-a-tool">Using bundler with a tool</h3>

<p>The recommended way for a Toys tool to depend on third-party gems is for the
tool to set up Bundler when it runs. The tool can load a bundle from an
appropriate <code>Gemfile</code> at runtime, by including the <code>:bundler</code> mixin.</p>

<p>Here&#39;s an example. Suppose you are writing a tool in a Rails app. It might, for
example, load the Rails environment and populate some data into the database.
Hence, it needs to run with your app&#39;s bundle, represented by your app&#39;s
<code>Gemfile</code>.</p>

<p>Simply <code>include :bundler</code> in your tool definition:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>populate-data</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:bundler</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># The bundle will be set up before the tool is run,
</span>    <span class='comment'># so you can now run code that depends on rails:
</span>    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>./config/environment.rb</span><span class='tstring_end'>&quot;</span></span>
    <span class='comment'># ... etc.
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>When the <code>:bundler</code> mixin is included in a tool, it installs a
<a href="#Mixin_initializers">mixin initializer</a> that calls <code>Bundler.setup</code> when the
tool is <em>executed</em>. This assumes the bundle is already installed, and brings
the appropriate gems into the Ruby load path. That is, it&#39;s basically the same
as <code>bundle exec</code>, but it applies only to the running tool.</p>

<p>In many cases, you might find that bundler is needed for many or most of the
tools you write for a particular project. In this case, you might find it
convenient to use
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#subtool_apply-instance_method">Toys::DSL::Tool#subtool_apply</a>
to include the bundle in all your tools. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Include bundler in every tool under this one
</span><span class='id identifier rubyid_subtool_apply'>subtool_apply</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:bundler</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>one-tool</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># This tool will run with the bundle
</span>  <span class='comment'># ...
</span><span class='kw'>end</span>

<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>another-tool</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># So will this tool
</span>  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<p>See the section on
<a href="#Applying_directives_to_multiple_tools">applying directives to multiple tools</a>
for more information on <code>subtool_apply</code>.</p>

<h4 id="bundler-options">Bundler options</h4>

<p>By default, the <code>:bundler</code> mixin will look for a <code>Gemfile</code> within the <code>.toys</code>
directory (if your tool is defined in one), and if one is not found there,
within the <a href="#The_context_directory">context directory</a> (the directory
containing your <code>.toys</code> directory or <code>.toys.rb</code>file), and if one still is not
found, in the current working directory. You can change this behavior by
passing an option to the <code>:bundler</code> mixin. For example, you can search only the
current working directory by passing <code>search_dirs: :current</code> as such:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>populate-data</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:bundler</span><span class='comma'>,</span> <span class='label'>search_dirs:</span> <span class='symbol'>:current</span>
  <span class='comment'># etc...
</span><span class='kw'>end</span>
</code></pre>

<p>You can also pass a specific directory path to this option.</p>

<p>If the bundle is not installed, or is out of date, Toys will ask you whether
you want it to install the bundle first before running the tool. A tool can
also choose to install the bundle without prompting, or simply to raise an
error, by passing another option to the <code>:bundler</code> mixin. For example, to
simply install the bundle without asking for confirmation:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>populate-data</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:bundler</span><span class='comma'>,</span> <span class='label'>on_missing:</span> <span class='symbol'>:install</span>
  <span class='comment'># etc...
</span><span class='kw'>end</span>
</code></pre>

<p>See the documentation for
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/StandardMixins/Bundler">Toys::StandardMixins::Bundler</a>
for more information about bundler options.</p>

<h4 id="solving-bundle-conflicts">Solving bundle conflicts</h4>

<p>It is important to understand that the <code>:bundler</code> mixin installs the bundle
when the tool <em>executes</em>, rather than when the tool is defined. Gems in the
bundle will not be available during tool definition, so for example you
<em>cannot</em> reference bundled gems when you are setting up the tool&#39;s flags,
description, or other directives. This is so that Toys can define tools with
competing bundles. Your Rails app&#39;s tools can use that app&#39;s bundle, while your
global tools can use a different bundle. They will not conflict because Toys
will not actually load a bundle until one or the other tool is executed. (This
is of course different from using <code>bundle exec</code>, which chooses and loads a
bundle before even starting Toys.)</p>

<p>If a <em>different</em> bundle (i.e. a different <code>Gemfile</code>) is already in effect when
a tool is run, then the <code>:bundler</code> mixin will raise an error. Ruby will not let
you set up two different bundles at the same time. This might happen, for
example, if you use <code>bundle exec</code> to run Toys, but the tool you are running
asks for a different bundle---one more reason not to use <code>bundle exec</code> with
Toys.</p>

<p>It might also happen if one tool that uses one bundle, <em>calls</em> a tool that uses
a different bundle. If you need to do this, use the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/StandardMixins/Exec#exec_separate_tool-instance_method">Toys::StandardMixins::Exec#exec_separate_tool</a>
method from the <code>:exec</code> mixin, to call the tool. This method spawns a separate
process with a clean Bundler setup for running the tool.</p>

<h3 id="activating-gems-directly">Activating gems directly</h3>

<p>Although we recommend the <code>:bundler</code> mixin for most cases, it is also possible
for a tool to install individual gems, using the <code>:gems</code> mixin. This mixin
provides a way for a tool to install individual gems without using Bundler.</p>

<p>Here&#39;s an example tool that just runs <code>rake</code>. Because it requires rake to be
installed in order to run the tool, we call the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/StandardMixins/Gems#gem-instance_method">Toys::StandardMixins::Gems#gem</a>
method (which is provided by the <code>:gems</code> mixin) at the beginning of the <code>run</code>
method:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rake</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:gems</span>
  <span class='id identifier rubyid_remaining_args'>remaining_args</span> <span class='symbol'>:rake_args</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rake</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>~&gt; 12.0</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_exec'>exec</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rake</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='id identifier rubyid_rake_args'>rake_args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>gem</code> method takes the name of the gem, and an optional set of version
requirements. If a gem matching the given version requirements is installed, it
is activated. If not, the gem is installed (which the user can confirm or
abort). Or, if Toys is being run in a bundle, a message is printed informing
the user that they need to add the gem to their Gemfile.</p>

<p>If a gem satisfying the given version constraints is already activated, it
remains active. If a gem with a conflicting version is already activated, an
exception is raised.</p>

<p>The <code>:gems</code> mixin also provides a <code>gem</code> <em>directive</em> that ensures a gem is
installed while the tool is being defined. In general, we recommend avoiding
doing this, because it could make your tool incompatible with another tool that
might need a competing gem during its definition. Toys would not be able to
define both tools together. However, occasionally it might be useful.</p>

<p>Here&#39;s an example tool with flags for each of the HighLine styles. Because
highline is needed to decide what flags to define, we use the <code>gem</code> directive
to ensure highline is installed while the tool is being defined.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>highline-styles-demo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:gems</span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>highline</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>~&gt; 2.0</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>highline</span><span class='tstring_end'>&quot;</span></span>
  <span class='const'>HighLine</span><span class='op'>::</span><span class='const'>BuiltinStyles</span><span class='op'>::</span><span class='const'>STYLES</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_style'>style</span><span class='op'>|</span>
    <span class='id identifier rubyid_style'>style</span> <span class='op'>=</span> <span class='id identifier rubyid_style'>style</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
    <span class='id identifier rubyid_flag'>flag</span> <span class='id identifier rubyid_style'>style</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_style'>style</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Apply </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_style'>style</span><span class='embexpr_end'>}</span><span class='tstring_content'> to the text</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>If you are not in the Toys DSL contextfor example from a class-based
mixinyou should use
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Utils/Gems#activate-class_method">Toys::Utils::Gems.activate</a>
instead. (Note that you must <code>require &quot;toys/utils/gems&quot;</code> explicitly before
invoking the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Utils/Gems">Toys::Utils::Gems</a>
class because, like all classes under <code>Toys::Utils</code>, Toys does not load it
automatically.) For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>toys/utils/gems</span><span class='tstring_end'>&quot;</span></span>
<span class='const'><span class='object_link'><a href="Toys.html" title="Toys (module)">Toys</a></span></span><span class='op'>::</span><span class='const'>Utils</span><span class='op'>::</span><span class='const'>Gems</span><span class='period'>.</span><span class='id identifier rubyid_activate'>activate</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>highline</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>~&gt; 2.0</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
</code></pre>

<p>Note these methods are a bit different from the
<a href="http://ruby-doc.org/stdlib/libdoc/rubygems/rdoc/Kernel.html">gem method</a>
provided by Rubygems. The Toys version attempts to install a missing gem for
you, whereas Rubygems will just throw an exception.</p>

<h3 id="useful-gems">Useful gems</h3>

<p>Now that you know how to ensure a gem is installed, either individually or as
part of a bundle, let&#39;s look at some third-party gems that you might find
useful when writing tools.</p>

<p>We already saw how to use the <strong>highline</strong> gem. Highline generally provides two
features: terminal styling, and prompts. For these capabilities and many more,
you might also consider <a href="https://github.com/piotrmurach/tty">TTY</a>. It comprises
a suite of gems that you can use separately or in tandem. Here are a few
examples.</p>

<p>To produce styled output, consider
<a href="https://github.com/piotrmurach/pastel">Pastel</a>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>fancy-output</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pastel</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_pastel'>pastel</span> <span class='op'>=</span> <span class='const'>Pastel</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_pastel'>pastel</span><span class='period'>.</span><span class='id identifier rubyid_red'>red</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Rubies!</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>To create rich user prompts, consider
<a href="https://github.com/piotrmurach/tty-prompt">tty-prompt</a>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>favorite-language</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tty-prompt</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_prompt'>prompt</span> <span class='op'>=</span> <span class='const'>TTY</span><span class='op'>::</span><span class='const'>Prompt</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='id identifier rubyid_lang'>lang</span> <span class='op'>=</span> <span class='id identifier rubyid_prompt'>prompt</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>What is your favorite language?</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                         <span class='qwords_beg'>%w[</span><span class='tstring_content'>Elixir</span><span class='words_sep'> </span><span class='tstring_content'>Java</span><span class='words_sep'> </span><span class='tstring_content'>Python</span><span class='words_sep'> </span><span class='tstring_content'>Ruby</span><span class='words_sep'> </span><span class='tstring_content'>Rust</span><span class='words_sep'> </span><span class='tstring_content'>Other</span><span class='tstring_end'>]</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_prompt'>prompt</span><span class='period'>.</span><span class='id identifier rubyid_say'>say</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_lang'>lang</span><span class='embexpr_end'>}</span><span class='tstring_content'> is awesome!</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>To create tabular output, consider
<a href="https://github.com/piotrmurach/tty-table">tty-table</a>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>matrix</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tty-table</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='const'>TTY</span><span class='op'>::</span><span class='const'>Table</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Language</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Creator</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                           <span class='lbracket'>[</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Ruby</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Matz</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                            <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Python</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Guido</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                            <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Elixir</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Jose</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_render'>render</span><span class='lparen'>(</span><span class='symbol'>:ascii</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>To show progress, consider
<a href="https://github.com/piotrmurach/tty-progressbar">tty-progressbar</a> for
deterministic processes, or
<a href="https://github.com/piotrmurach/tty-spinner">tty-spinner</a> for
non-deterministic.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>waiting</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tty-progressbar</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_bar'>bar</span> <span class='op'>=</span> <span class='const'>TTY</span><span class='op'>::</span><span class='const'>ProgressBar</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Waiting [:bar]</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>total:</span> <span class='int'>30</span><span class='rparen'>)</span>
    <span class='int'>30</span><span class='period'>.</span><span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='float'>0.1</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_bar'>bar</span><span class='period'>.</span><span class='id identifier rubyid_advance'>advance</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>A variety of other useful gems can also be found in
<a href="https://lab.hookops.com/ruby-cli-gems.html">this article</a>.</p>

<h2 id="toys-as-a-rake-replacement">Toys as a Rake replacement</h2>

<p>Toys was designed to organize scripts that may be &quot;scoped&quot; to a project or
directory. Rake is also commonly used for this purpose: you can write a
&quot;Rakefile&quot; that defines rake tasks scoped to a directory. In many cases, Toys
can be used as a replacement for Rake. Indeed, the Toys repository itself
contains a <code>.toys.rb</code> file instead of a Rakefile, for running tests, builds,
and so forth.</p>

<p>This section will explore the differences between Toys and Rake, and describe
how to use Toys for some of the things traditionally done with Rake.</p>

<h3 id="comparing-toys-and-rake">Comparing Toys and Rake</h3>

<p>Although Toys and Rake serve many of the same use cases, they have very
different design goals, and it is useful to understand them.</p>

<p>Rake&#39;s design is based on the classic &quot;make&quot; tool often provided in unix
development environments. This design focuses on <em>targets</em> and <em>dependencies</em>,
and is meant for a world where you invoke an external compiler tool whenever
changes are made to an individual source file or any of its dependencies. This
&quot;declarative&quot; approach expresses very well the build process for programs
written in C and similar compiled languages.</p>

<p>Ruby, however, does not have an external compiler, and certainly not one that
requires separate invocation for each source file as does the C compiler. So
although Rake does support file dependencies, they are much less commonly used
than in their Makefile cousins. Instead, in practice, most Rake tasks are not
connected to a dependency at all; they are simply standalone scripts, what
would be called &quot;phony&quot; targets in a Makefile. Such tasks are more imperative
than declarative.</p>

<p>The Toys approach to build tools simply embraces the fact that our build
processes already tend to be imperative. So unlike Rake, Toys does not provide
syntax for describing targets and dependencies, since we generally don&#39;t have
them in Ruby programs. Instead, it is optimized for writing tools.</p>

<p>For example, Rake provides a primitive mechanism for passing arguments to a
task, but it is clumsy and quite different from most unix programs. However, to
do otherwise would clash with Rake&#39;s design goal of treating tasks as targets
and dependencies. Toys does not have those design goals, so it is able to
embrace the familiar unix conventions for command line arguments.</p>

<p>Toys actually borrows some of its design from the &quot;mix&quot; build tool used for
Elixir and Erlang programs. Unlike C, the Erlang and Elixir compilers do their
own dependency management, so mix does not require those capabilities. Instead,
it focuses on making it easy to define imperative tasks.</p>

<p>All told, this boils down to the principle of using the best tool for the job.
There will be times when you need to express file-based dependencies in some of
your build tasks. Rake will continue to be your friend in those cases. However,
for imperative tasks such as &quot;run my tests&quot;, &quot;build my YARD documentation&quot;, or
&quot;release my gem&quot;, you may find Toys easier to use.</p>

<h3 id="using-toys-to-invoke-rake-tasks">Using Toys to invoke Rake tasks</h3>

<p>If you&#39;ve already written a Rakefile for your project, Toys provides a
convenient way to invoke your existing Rake tasks using Toys. The built-in
<code>:rake</code> template reads a Rakefile and automatically generates corresponding
tools.</p>

<p>In the same directory as your Rakefile, create a <code>.toys.rb</code> file with the
following contents:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># In .toys.rb
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:rake</span>
</code></pre>

<p>Now within that directory, if you had a Rake task called <code>test</code>, you can invoke
it with:</p>

<pre class="code ruby"><code class="ruby">$ toys test
</code></pre>

<p>Similarly, a Rake task named <code>test:integration</code> can be invoked with either of
the following:</p>

<pre class="code ruby"><code class="ruby">$ toys test integration
$ toys test:integration
</code></pre>

<p>Rake tasks with arguments are mapped to tool arguments, making it easier to
invoke those tasks using Toys. For example, consider a Rake task with two
arguments, defined as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># In Rakefile
</span><span class='id identifier rubyid_task'>task</span> <span class='symbol'>:my_task</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='symbol'>:first</span><span class='comma'>,</span> <span class='symbol'>:second</span><span class='rbracket'>]</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_task'>task</span><span class='comma'>,</span> <span class='id identifier rubyid_args'>args</span><span class='op'>|</span>
  <span class='id identifier rubyid_do_something_with'>do_something_with</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='symbol'>:first</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_do_something_else_with'>do_something_else_with</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='symbol'>:second</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<p>would have to be invoked as follows using rake:</p>

<pre class="code ruby"><code class="ruby">$ rake my_task[value1,value2]
</code></pre>

<p>You may even need to escape the brackets if you are using a shell that treats
them specially. Toys will let you pass them as normal command line arguments:</p>

<pre class="code ruby"><code class="ruby">$ toys my_task value1 value2
</code></pre>

<p>The <code>:rake</code> template provides several options. If your Rakefile is named
something other than <code>Rakefile</code> or isn&#39;t in the current directory, you can
pass an explicit path to it when expanding the template:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># In .toys.rb
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:rake</span><span class='comma'>,</span> <span class='label'>rakefile_path:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>path/to/my_rakefile</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>You may also choose to pass arguments as named flags rather than command line
arguments. Set <code>:use_flags</code> when expanding the template:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># In .toys.rb
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:rake</span><span class='comma'>,</span> <span class='label'>use_flags:</span> <span class='kw'>true</span>
</code></pre>

<p>Now with this option, to pass arguments to the tool, use the argument names as
flags:</p>

<pre class="code ruby"><code class="ruby">$ toys my_task --first=value1 --second=value2
</code></pre>

<h3 id="from-rakefiles-to-toys-files">From Rakefiles to Toys files</h3>

<p>Invoking Rake tasks using Toys is an easy first step, but eventually you will
likely want to migrate some of your project&#39;s build tasks from Rake to Toys.
The remainder of this section describes the common patterns and features Toys
provides for writing build tasks that are traditionally done with Rake.</p>

<p>Many common Rake tasks can be generated using code provided by either Rake or
the third party library. Different libraries provide different mechanisms for
task generation. For example, a test task might be defined like this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rake/testtask</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>Rake</span><span class='op'>::</span><span class='const'>TestTask</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_test_files'>test_files</span> <span class='op'>=</span> <span class='const'>FileList</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test/test*.rb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<p>In Toys, templates are the standard mechanism for generating tools.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:minitest</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_files'>files</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test/test*.rb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<p>The following sections will describe some of the built-in templates provided by
Toys to generate common build tools.</p>

<p>Note that Rakefiles and Toys files can coexist in the same directory, so you
can use either or both tools, depending on your needs.</p>

<h3 id="running-tests">Running tests</h3>

<p>Toys provides a built-in template called <code>:minitest</code> for running unit tests
with <a href="https://github.com/seattlerb/minitest">minitest</a>. The following example
directive uses the minitest template to create a tool called <code>test</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:minitest</span><span class='comma'>,</span> <span class='label'>files:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test/test*.rb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>libs:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lib</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ext</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
</code></pre>

<p>See the <span class='object_link'><a href="Toys/Templates/Minitest.html" title="Toys::Templates::Minitest (class)">Toys::Templates::Minitest</a></span> documentation for details on the available
options.</p>

<p>Toys also provides a built-in template called <code>:rspec</code> for running BDD examples
using <a href="http://rspec.info">RSpec</a>. The following example directive uses this
template to create a tool called <code>spec</code>:</p>

<pre class="code ruby"><code class="ruby">expand :rspec, pattern: &quot;spec/**/*_spec.rb&quot;, libs: [&quot;lib, &quot;ext&quot;]
</code></pre>

<p>See the <span class='object_link'><a href="Toys/Templates/Rspec.html" title="Toys::Templates::Rspec (class)">Toys::Templates::Rspec</a></span> documentation for details on the available
options.</p>

<p>If you want to enforce code style using the
<a href="https://rubygems.org/gems/rubocop">rubocop gem</a>, you can use the built-in
<code>:rubocop</code> template. The following directive uses this template to create a
tool called <code>rubocop</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:rubocop</span>
</code></pre>

<p>See the <span class='object_link'><a href="Toys/Templates/Rubocop.html" title="Toys::Templates::Rubocop (class)">Toys::Templates::Rubocop</a></span> documentation for details on the available
options.</p>

<h3 id="building-and-releasing-gems">Building and releasing gems</h3>

<p>The <code>:gem_build</code> built-in template can generate a variety of build and release
tools for gems, and is a useful alternative to the Rake tasks provided by
bundler. It is implemented by <span class='object_link'><a href="Toys/Templates/GemBuild.html" title="Toys::Templates::GemBuild (class)">Toys::Templates::GemBuild</a></span>. The following
directive uses this template to create a tool called <code>build</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:gem_build</span>
</code></pre>

<p>The <code>:gem_build</code> template by default looks for a gemspec file in the current
directory, and builds that gem into a <code>pkg</code> directory. You can also build a
specific gem if you have multiple gemspec files.</p>

<p>You may also configure the template so it also releases the gem to Rubygems
(using your stored Rubygems credentials), by setting the <code>push_gem</code> option.
For example, here is how to generate a &quot;release&quot; tool that builds and releases
your gem:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:gem_build</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>release</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>push_gem:</span> <span class='kw'>true</span>
</code></pre>

<p>See the <span class='object_link'><a href="Toys/Templates/GemBuild.html" title="Toys::Templates::GemBuild (class)">Toys::Templates::GemBuild</a></span> documentation for details on the various
options for build tools.</p>

<p>To create a &quot;clean&quot; tool, you can use the <code>:clean</code> built-in template. For
example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:clean</span><span class='comma'>,</span> <span class='label'>paths:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pkg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>doc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tmp</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
</code></pre>

<p>See the <span class='object_link'><a href="Toys/Templates/Clean.html" title="Toys::Templates::Clean (class)">Toys::Templates::Clean</a></span> documentation for details on the various
options for clean.</p>

<h3 id="building-documentation">Building documentation</h3>

<p>Toys provides an <code>:rdoc</code> template for creating tools that generate RDoc
documentation, and a <code>:yardoc</code> template for creating tools that generate YARD.
Both templates provide a variety of options for controlling documentation
generation. See <span class='object_link'><a href="Toys/Templates/Rdoc.html" title="Toys::Templates::Rdoc (class)">Toys::Templates::Rdoc</a></span> and <span class='object_link'><a href="Toys/Templates/Yardoc.html" title="Toys::Templates::Yardoc (class)">Toys::Templates::Yardoc</a></span> for
detailed information.</p>

<p>Here&#39;s an example for YARD, creating a tool called <code>yardoc</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:yardoc</span><span class='comma'>,</span> <span class='label'>protected:</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='label'>markup:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>markdown</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<h3 id="gem-example">Gem example</h3>

<p>Let&#39;s look at a complete example that combines the techniques above to provide
all the basic tools for a Ruby gem. It includes:</p>

<ul>
<li>A testing tool that can be invoked using <code>toys test</code></li>
<li>Code style checking using Rubocop, invoked using <code>toys rubocop</code></li>
<li>Documentation building using Yardoc, invoked using <code>toys yardoc</code></li>
<li>Gem building, invoked using <code>toys build</code></li>
<li>Gem build and release to Rubygems.org, invoked using <code>toys release</code></li>
<li>A full CI tool, invoked using <code>toys ci</code>, that can be run from your favorite
CI system. It runs the tests and style checks, and checks (but does not
actually build) the documentation for warnings and completeness.</li>
</ul>

<p>Below is the full annotated <code>.toys.rb</code> file. For many gems, you could drop this
into the gem source repo with minimal or no modifications. Indeed, it is very
similar to the Toys files provided for the <strong>toys</strong> and <strong>toys-core</strong> gems
themselves.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># This file is .toys.rb
</span>
<span class='comment'># A &quot;clean&quot; tool that cleans out gem builds (from the pkg directory), and
</span><span class='comment'># documentation builds (from doc and .yardoc)
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:clean</span><span class='comma'>,</span> <span class='label'>paths:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pkg</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>doc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.yardoc</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

<span class='comment'># This is the &quot;test&quot; tool.
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:minitest</span><span class='comma'>,</span> <span class='label'>libs:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lib</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

<span class='comment'># This is the &quot;rubocop&quot; tool.
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:rubocop</span>

<span class='comment'># This is the &quot;yardoc&quot; tool. We cause it to fail on warnings and if there
</span><span class='comment'># are any undocumented objects, which is useful for CI. We also configure
</span><span class='comment'># the tool so it recognizes the &quot;--no-output&quot; flag. The CI tool will use
</span><span class='comment'># this flag to invoke yardoc but suppress output, because it just wants to
</span><span class='comment'># check for warnings.
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:yardoc</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_generate_output_flag'>generate_output_flag</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_fail_on_warning'>fail_on_warning</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_fail_on_undocumented_objects'>fail_on_undocumented_objects</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='kw'>end</span>

<span class='comment'># The normal &quot;build&quot; tool that just builds a gem into the pkg directory.
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:gem_build</span>

<span class='comment'># An &quot;install&quot; tool that builds the gem and installs it locally.
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:gem_build</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>install</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>install_gem:</span> <span class='kw'>true</span>

<span class='comment'># A full gem &quot;release&quot; tool that builds the gem, and pushes it to rubygems.
</span><span class='comment'># This assumes your local rubygems configuration is set up with the proper
</span><span class='comment'># credentials.
</span><span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:gem_build</span><span class='comma'>,</span> <span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>release</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>push_gem:</span> <span class='kw'>true</span>

<span class='comment'># Now we create a full CI tool. It runs the test, rubocop, and yardoc tools
</span><span class='comment'># and checks for errors. This tool could be invoked from a CI system.
</span><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ci</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># The :exec mixin provides the exec_tool() method that we will use to run
</span>  <span class='comment'># other tools and check their exit status.
</span>  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:exec</span>
  <span class='comment'># The :terminal mixin provides an enhanced &quot;puts&quot; method that lets you
</span>  <span class='comment'># write styled text to the terminal.
</span>  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:terminal</span>

  <span class='comment'># A helper method, that runs a tool and outputs the result. It also
</span>  <span class='comment'># terminates if the tool reported an error.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run_stage'>run_stage</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_tool'>tool</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_exec_tool'>exec_tool</span><span class='lparen'>(</span><span class='id identifier rubyid_tool'>tool</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>
      <span class='id identifier rubyid_puts'>puts</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>** </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> passed</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:green</span><span class='comma'>,</span> <span class='symbol'>:bold</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_puts'>puts</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_puts'>puts</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>** CI terminated: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='embexpr_end'>}</span><span class='tstring_content'> failed!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:red</span><span class='comma'>,</span> <span class='symbol'>:bold</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_exit'>exit</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># The main run method. It just calls the above helper method for the
</span>  <span class='comment'># three tools we want to run for CI
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_run_stage'>run_stage</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Tests</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_run_stage'>run_stage</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Style checker</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rubocop</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_run_stage'>run_stage</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Docs generation</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>yardoc</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--no-output</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h2 id="advanced-tool-definition-techniques">Advanced tool definition techniques</h2>

<p>This section covers some additional features that are often useful for writing
tools. I&#39;ve labeled them &quot;advanced&quot;, but all that really means is that this
user&#39;s guide didn&#39;t happen to have covered them until this section. Each of
these features is very useful for certain types of tools, and it is good at
least to know that you <em>can</em> do these things, even if you don&#39;t use them
regularly.</p>

<h3 id="delegating-tools">Delegating tools</h3>

<p>A tool may <strong>delegate</strong> to another tool, which means it uses the other tool&#39;s
flags, arguments, and execution. Effectively, it becomes an &quot;alias&quot;---that is,
an alternate name---for the target tool.</p>

<p>For example, suppose you have a tool called <code>test</code> that can be invoked with
<code>toys test</code>. You could define a tool <code>t</code> that delegates to <code>test</code>. Then,
running <code>toys t</code> will have the same effect as <code>toys test</code>.</p>

<p>To delegate a tool, pass the <code>:delegate_to</code> keyword argument to the <code>tool</code>
directive. For example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># Define test tool here...
</span><span class='kw'>end</span>

<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>t</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>delegate_to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Tools can delegate to tools or namespaces. For example, you can delegate <code>sys</code>
to the built-in namespace <code>system</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sys</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>delegate_to:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>system</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>That will let you run <code>toys sys version</code> (which will be the equivalent of
<code>toys system version</code>).</p>

<p>To delegate to a subtool, pass an array, or a string delimited by <code>&quot;:&quot;</code> or
<code>&quot;.&quot;</code> characters, as the target:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gem</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># Define the tool here
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>delegate_to:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gem</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
</code></pre>

<p>In most cases, if a tool delegates to another tool, you should not do anything
else with it. For example, it should not have its own implementation or contain
any subtools. However, there are a few exceptions. You might, for example, want
a namespace to delegate to one of its subtools:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>delegate_to:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unit</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># Run unit tests
</span>  <span class='kw'>end</span>
  <span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>integration</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='comment'># Run integration tests
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Now <code>toys test</code> delegates to, and thus has the same effect as <code>toys test unit</code>.</p>

<h3 id="applying-directives-to-multiple-tools">Applying directives to multiple tools</h3>

<p>Sometimes a group of tools are set up similarly or share a set of flags,
mixins, or other directives. You can apply a set of directives to all subtools
(recursively) of the current tool, using the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#subtool_apply-instance_method">Toys::DSL::Tool#subtool_apply</a>
directive.</p>

<p>For example, it is common for tools to use the <code>:exec</code> built-in mixin to invoke
external programs. You can use <code>subtool_apply</code> to ensure that the mixin is
included in all subtools, so that you do not need to repeat the <code>include</code>
directive in every tool.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_subtool_apply'>subtool_apply</span> <span class='kw'>do</span>
  <span class='comment'># Include the mixin only if the tool hasn&#39;t already done so
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:exec</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:exec</span><span class='comma'>,</span> <span class='label'>exit_on_nonzero_status:</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-tool</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># This tool has access to methods defined by the :exec mixin
</span>    <span class='comment'># because the above block is applied to the tool
</span>    <span class='id identifier rubyid_sh'>sh</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>echo hello</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Importantly, <code>subtool_apply</code> blocks are &quot;applied&quot; at the <em>end</em> of a tool&#39;s
definition. Therefore, when using <code>subtool_apply</code>, you have the ability to look
at the current definition of the tool to decide whether to apply further
changes. The <code>subtool_apply</code> block in the above example uses this technique; it
checks whether the <code>:exec</code> mixin has already been included before attempting to
include it. Thus, it is possible for a tool to &quot;override&quot; the inclusion, say,
to use a different configuration:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>another-tool</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='comment'># Use a different configuration for the :exec mixin.
</span>  <span class='comment'># This &quot;overrides&quot; the subtool_apply block above.
</span>  <span class='id identifier rubyid_include'>include</span> <span class='symbol'>:exec</span><span class='comma'>,</span> <span class='label'>exit_on_nonzero_status:</span> <span class='kw'>false</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># This is run with exit_on_nonzero_status: false
</span>    <span class='id identifier rubyid_sh'>sh</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>echo hello</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="custom-acceptors">Custom acceptors</h3>

<p>We saw earlier that flags and positional arguments can have acceptors, which
control the allowed format, and may also convert the string argument to a Ruby
object. By default, Toys supports the same acceptors recognized by Ruby&#39;s
OptionParser library. And like OptionParser, Toys also lets you define your own
acceptors.</p>

<p>Define an acceptor using the <code>acceptor</code> directive. You provide a name for the
acceptor, and specify how to validate input strings and how to convert input
strings to Ruby objects. You may then reference the acceptor in that tool or
any of its subtools or their subtools, recursively.</p>

<p>There are several ways to define an acceptor.</p>

<p>You may validate input strings against a regular expression, by passing the
regex to the <code>acceptor</code> directive. You may also optionally provide a block to
convert input strings to objects (or omit the block to use the original string
as the option value.) For example, a simple hexadecimal input acceptor might
look like this:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_acceptor'>acceptor</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hex</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[0-9a-fA-F]+$</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_input'>input</span><span class='op'>|</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='lparen'>(</span><span class='int'>16</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
</code></pre>

<p>You may also accept enum values by passing an array of valid values to the
<code>acceptor</code> directive. Inputs will be matched against the <code>to_s</code> form of the
given values, and will be converted to the value itself. For example, one way
to accept integers from 1 to 5 is:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_acceptor'>acceptor</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1to5</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span> <span class='int'>2</span><span class='comma'>,</span> <span class='int'>3</span><span class='comma'>,</span> <span class='int'>4</span><span class='comma'>,</span> <span class='int'>5</span><span class='rbracket'>]</span><span class='rparen'>)</span>
</code></pre>

<p>There are various other options. See the reference documentation for
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#acceptor-instance_method">Toys::DSL::Tool#acceptor</a>.</p>

<p>An acceptor is available to the tool in which it is defined, and any subtools
and descendants defined at the same point in the Toys search path, but not from
tools defined in a different point in the search path. For example, if you
define an acceptor in a file located in a <code>.toys</code> directory, it will be visible
to descendant tools defined in that same directory, but not in a different
<code>.toys</code> directory.</p>

<p>A common technique, for example, would be to define an acceptor in the index
file in a Toys directory. You can then include it from any subtools defined in
other files in that same directory.</p>

<h3 id="controlling-built-in-flags">Controlling built-in flags</h3>

<p>Earlier we saw that certain flags are added automatically to every tool:
<code>--verbose</code>, <code>--quiet</code>, <code>--help</code>, and so forth. You may occasionally want to
disable some of these &quot;built-in&quot; flags. There are two ways to do so:</p>

<p>If you want to use one of the built-in flags for another purpose, simply define
the flag as you choose. Flags explicitly defined by your tool take precedence
over the built-ins.</p>

<p>For example, normally two built-in flags are provided to decrease the verbosity
level: <code>-q</code> and <code>--quiet</code>. If you define <code>-q</code> yourself (for example to activate
a &quot;quick&quot; mode) then <code>-q</code> will be repurposed for your flag, but <code>--quiet</code> will
still be present to decrease verbosity.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Repurposes -q to set the &quot;quick&quot; option instead of &quot;quiet&quot;
</span><span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:quick</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-q</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>You may also completely disable a flag, and <em>not</em> repurpose it, using the
<code>disable_flag</code> directive. It lets you mark one or more flags as &quot;never use&quot;.</p>

<p>For example, if you disable the <code>-q</code> flag, then <code>-q</code> will no longer be a
built-in flag that decreases the verbosity, but <code>--quiet</code> will remain. To
completely disable decreasing the verbosity, disable both <code>-q</code> and <code>--quiet</code>.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Disables -q but leaves --quiet
</span><span class='id identifier rubyid_disable_flag'>disable_flag</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-q</span><span class='tstring_end'>&quot;</span></span>

<span class='comment'># Completely disables decreasing verbosity
</span><span class='id identifier rubyid_disable_flag'>disable_flag</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-q</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--quiet</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<h3 id="enforcing-flags-before-args">Enforcing flags before args</h3>

<p>By default, tools allow flags and positional arguments to be interspersed when
command line arguments are parsed. This matches the behavior of most common
command line binaries.</p>

<p>However, some tools prefer to follow the convention that all flags must appear
first, followed by positional arguments. In such a tool, once a non-flag
argument appears on the command line, all remaining arguments are treated as
positional, even if they look like a flag and start with a hyphen.</p>

<p>You may configure a tool to follow this alternate parsing strategy using the
<code>enforce_flags_before_args</code> directive.</p>

<p>The built-in tool <code>toys do</code> is an example of a tool that does this. It
recognizes its own flags (such as <code>--help</code> and <code>--delim</code>) but once positional
arguments start appearing, it wants further flags to be treated as positional
so it can pass them down to the different steps it is executing. Here is a
simplified excerpt from the implementation that tool:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>do</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:delim</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>,</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_remaining_args'>remaining_args</span> <span class='symbol'>:commands</span>  <span class='comment'># the commands to execute
</span>  <span class='id identifier rubyid_enforce_flags_before_args'>enforce_flags_before_args</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># Now commands includes both the commands to run and
</span>    <span class='comment'># the &quot;flags&quot; to pass to them.
</span>    <span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span>
      <span class='comment'># ...
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="requiring-exact-flag-matches">Requiring exact flag matches</h3>

<p>By default, tools will recognized &quot;shortened&quot; forms of long flags. For example,
most suppose you are defining a tool with long flags:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-tool</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:long_flag_name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--long-flag-name</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:another_long_flag</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--another-long-flag</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>When you invoke this tool, you do not need to type the entire flag names.
Abbreviations will also work:</p>

<pre class="code ruby"><code class="ruby">$ toys my-tool --long --an
</code></pre>

<p>As long as the abbreviation is unambiguous (i.e. there is no other flag that
begins with the same string), the Toys argument parser will recognize the flag.
This is consistent with the behavior of most command line tools (and is also
the behavior of Ruby&#39;s OptionParser library.)</p>

<p>However, it is possible to disable this behavior and require that flags be
presented in their entirety, using the <code>require_exact_flag_match</code> directive.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-tool</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_require_exact_flag_match'>require_exact_flag_match</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:long_flag_name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--long-flag-name</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:another_long_flag</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--another-long-flag</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Now, all flags for this tool must be presented in their entirety. Abbreviations
are not allowed.</p>

<pre class="code ruby"><code class="ruby">$ toys my-tool --long-flag-name --another-long-flag
</code></pre>

<p>Currently you can require exact flag matches only at the tool level, applied to
all flags for that tool. You cannot set this option for individual flags.</p>

<h3 id="disabling-argument-parsing">Disabling argument parsing</h3>

<p>Normally Toys handles parsing command line arguments for you. This makes
writing tools easier, and also allows Toys to generate documentation
automatically for flags and arguments. However, occasionally you&#39;ll want Toys
not to perform any parsing, but just to give you the command line arguments
raw. One common case is if your tool turns around and passes its arguments
verbatim to a subprocess.</p>

<p>To disable argument parsing, use the <code>disable_argument_parsing</code> directive. This
directive disables parsing and validation of flags and positional arguments.
(Thus, it is incompatible with specifying any flags or arguments for the tool.)
Instead, you can retrieve the raw arguments using the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#args-instance_method">Toys::Context#args method</a>.</p>

<p>Here is an example that wraps calls to git:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my-git</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_desc'>desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Prints a message, and then calls git normally</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_disable_argument_parsing'>disable_argument_parsing</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Calling my-git!</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_exec'>exec</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>git</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="handling-interrupts">Handling interrupts</h3>

<p>If you interrupt a running tool, say, by hitting <code>CTRL</code>-<code>C</code>, Toys will normally
terminate execution and display the message <code>INTERRUPTED</code> on the standard error
stream.</p>

<p>If your tool needs to handle interrupts itself, you have several options. You
can rescue the <code>Interrupt</code> exception or call <code>Signal.trap</code>. Or you can provide
an <em>interrupt handler</em> in your tool using the <code>on_interrupt</code> directive. This
directive either provides a block to handle interrupts, or designates a named
method as the handler. If an interrupt handler is present, Toys will handle
interrupts as follows:</p>

<ol>
<li> Toys will terminate the tool&#39;s <code>run</code> method by raising an <code>Interrupt</code>
exception. Any <code>ensure</code> blocks will be called.</li>
<li> Toys will call the interrupt handler. If this method or block takes an
argument, Toys will pass it the <code>Interrupt</code> exception object.</li>
<li> The interrupt handler is then responsible for tool execution from that
point. It may terminate execution by returning or calling <code>exit</code>, or it may
restart or resume processing (perhaps by calling the <code>run</code> method again).
Or it may invoke the normal Toys interrupt handling (i.e. terminating
execution, displaying the message <code>INTERRUPTED</code>) by re-raising <em>the same</em>
interrupt exception object.</li>
<li> If another interrupt takes place during the execution of the interrupt
handler, Toys will terminate it by raising a <em>second</em> <code>Interrupt</code> exception
(calling any <code>ensure</code> blocks). Then, the interrupt handler will be called
<em>again</em> and passed the new exception. Any additional interrupts will be
handled similarly.</li>
</ol>

<p>Because the interrupt handler is called again even if it is itself interrupted,
you might consider detecting this case if your interrupt handler might be
long-running. You can tell how many interrupts have taken place by looking at
the <code>Exception#cause</code> property of the exception. The first interrupt will have
a cause of <code>nil</code>. The second interrupt (i.e. the interrupt raised the first
time the interrupt handler is itself interrupted) will have its cause point to
the first interrupt (which in turn has a <code>nil</code> cause.) The third interrupt&#39;s
cause will point to the second interrupt, and so on. So you can determine the
interrupt &quot;depth&quot; by counting the length of the cause chain.</p>

<p>Here is an example that performs a long-running task. The first two times the
task is interrupted, it is restarted. The third time, it is terminated.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>long-running</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_long_task'>long_task</span><span class='lparen'>(</span><span class='id identifier rubyid_is_restart'>is_restart</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>task </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_is_restart'>is_restart</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>re</span><span class='tstring_end'>&#39;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'>starting...</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_sleep'>sleep</span> <span class='int'>10</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>task finished!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_long_task'>long_task</span><span class='lparen'>(</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_on_interrupt'>on_interrupt</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ex'>ex</span><span class='op'>|</span>
    <span class='comment'># The third interrupt will have a non-nil ex.cause.cause.
</span>    <span class='comment'># At that time, just give up and re-raise the exception, which causes
</span>    <span class='comment'># it to propagate out and invoke the standard Toys interrupt handler.
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_ex'>ex</span> <span class='kw'>if</span> <span class='id identifier rubyid_ex'>ex</span><span class='period'>.</span><span class='id identifier rubyid_cause'>cause</span><span class='op'>&amp;.</span><span class='id identifier rubyid_cause'>cause</span>
    <span class='comment'># Otherwise, restart the long task.
</span>    <span class='id identifier rubyid_long_task'>long_task</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="handling-usage-errors">Handling usage errors</h3>

<p>Normally, if Toys detects a usage error (such as an unrecognized flag) while
parsing arguments, it will respond by aborting the tool and displaying the
usage error. It is possible to override this behavior by providing your own
usage error handler using the <code>on_usage_error</code> directive. This directive either
provides a block to handle usage errors, or designates a named method as the
handler.</p>

<p>If your handler block or method takes a parameter, Toys will pass it the array
of usage errors. Otherwise, you can get the array by calling
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#usage_errors-instance_method">Toys::Context#usage_errors</a>.
This array will provide you with a list of the usage errors encountered.</p>

<p>You can also get information about the arguments that could not be parsed from
the context. For example, the list of unrecognized flags is available from the
context key <code>UNMATCHED_FLAGS</code>.</p>

<p>One common technique is to redirect usage errors back to the <code>run</code> method. In
this way, <code>run</code> is called regardless of whether argument parsing succeeded or
failed.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lenient-parser</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_flag'>flag</span> <span class='symbol'>:abc</span>

  <span class='id identifier rubyid_on_usage_error'>on_usage_error</span> <span class='symbol'>:run</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_usage_errors'>usage_errors</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Usage was correct</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Usage was not correct</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3 id="data-files">Data files</h3>

<p>If your tools require images, archives, keys, or other such static data, Toys
provides a convenient place to put data files that can be looked up by tools
either during definition or runtime.</p>

<p>To use data files, you must define your tools inside a
<a href="#Toys_directories">Toys directory</a>. Within the Toys directory, create a
directory named <code>.data</code> and copy your data files there.</p>

<p>You may then &quot;find&quot; a data file by providing the relative path to the file from
the <code>.data</code> directory. When defining a tool, use the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/DSL/Tool#find_data-instance_method">Toys::DSL::Tool#find_data</a>
directive in a Toys file. Or, at tool execution time, call
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/Context#find_data-instance_method">Toys::Context#find_data</a>
(which is a convenience method for getting the tool source object using the
<code>TOOL_SOURCE</code> key, and calling
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/Toys/SourceInfo#find_data-instance_method">Toys::SourceInfo#find_data</a>
on it). In either case, <code>find_data</code> locates a matching file (or directory)
among the data files, and returns the full path to that file system object. You
may then read the file or perform any other operation on it.</p>

<p>For example, take the following directory structure:</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- .data/
   |  |
   |  +- greeting.txt
   |  |
   |  +- desc/
   |     |
   |     +- short.txt
   |
   +- greet.rb   &lt;-- defines &quot;greet&quot; (and subtools)
</code></pre>

<p>The data files in <code>.toys/.data</code> are available to any tool in the <code>.toys</code>
directory or any of its subdirectories. For example, suppose we want our
&quot;greet&quot; tool to use the contents of <code>greeting.txt</code>. We can call <code>find_data</code> to
read those contents when the tool is executed:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># greet.rb
</span><span class='id identifier rubyid_desc'>desc</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Print a friendly greeting.</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Whom to greet.</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_find_data'>find_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greeting.txt</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_greeting'>greeting</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>You can include directories in the argument to <code>find_data</code>. For example, here
is how to use the <code>find_data</code> directive to read the short description from the
file &quot;desc/short.txt&quot;:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># greet.rb
</span><span class='id identifier rubyid_desc'>desc</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_find_data'>find_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>desc/short.txt</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
<span class='id identifier rubyid_optional_arg'>optional_arg</span> <span class='symbol'>:whom</span><span class='comma'>,</span> <span class='label'>default:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>world</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>desc:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Whom to greet.</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
  <span class='id identifier rubyid_greeting'>greeting</span> <span class='op'>=</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span><span class='id identifier rubyid_find_data'>find_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>greeting.txt</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_greeting'>greeting</span><span class='embexpr_end'>}</span><span class='tstring_content'>, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_whom'>whom</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>The <code>find_data</code> mechanism will return the &quot;closest&quot; file or directory found.
In the example below, there is a <code>desc/short.txt</code> file in the <code>.data</code> directory
at the top level, but there is also a <code>desc/short.txt</code> file in the <code>.data</code>
directory under <code>test</code>. Tools under the <code>test</code> directory will find the more
specific data file, while other tools will find the more general file.</p>

<pre class="code ruby"><code class="ruby">(current directory)
|
+- .toys/
   |
   +- .data/
   |  |
   |  +- greeting.txt
   |  |
   |  +- desc/
   |     |
   |     +- short.txt  &lt;-- default description for all tools
   |
   +- greet.rb   &lt;-- defines &quot;greet&quot; (and subtools)
   |
   +- test/
      |
      +- .data/
      |  |
      |  +- desc/
      |     |
      |     +- short.txt  &lt;-- override description for test tools
      |
      +- unit.rb   &lt;-- defines &quot;test unit&quot; (and its subtools)
</code></pre>

<p>If, however, you find <code>greeting.txt</code> from a tool under <code>test</code>, it will still
find the more general <code>.toys/.data/greeting.txt</code> file because there is no
overriding file under <code>.toys/test/.data</code>.</p>

<h3 id="the-context-directory">The context directory</h3>

<p>The <strong>context directory</strong> for a tool is the directory containing the toplevel
<code>.toys.rb</code> file or the <code>.toys</code> directory within which the tool is defined. It
is sometimes useful for tools that expect to be run from a specific working
directory.</p>

<p>For example, suppose you have a Ruby project directory:</p>

<pre class="code ruby"><code class="ruby">my-project/
|
+- .toys.rb  &lt;-- project tools defined here
|
+- lib/
|
+- test/
|
etc...
</code></pre>

<p>Now suppose you defined a tool that lists the tests:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>list-tests</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='const'>Dir</span><span class='period'>.</span><span class='id identifier rubyid_glob'>glob</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test/**/*.rb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>This tool assumes it will be run from the main project directory (<code>my-project</code>
in the above case). However, Toys lets you invoke tools even if you are in a
subdirectory:</p>

<pre class="code ruby"><code class="ruby">$ cd lib
$ toys list-tests  # Does not work
</code></pre>

<p>Rake handles this by actually changing the current working directory to the
directory containing the active Rakefile. Toys, however, does not change the
working directory unless you tell it to. You can make the <code>list-tests</code> tool
work correctly by changing the directory to the context directory (which is the
directory containing the <code>.toys.rb</code> file, i.e. the <code>my-project</code> directory.)</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_tool'>tool</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>list-tests</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span>
    <span class='const'>Dir</span><span class='period'>.</span><span class='id identifier rubyid_chdir'>chdir</span> <span class='id identifier rubyid_context_directory'>context_directory</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='const'>Dir</span><span class='period'>.</span><span class='id identifier rubyid_glob'>glob</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>test/**/*.rb</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Note the context directory is different from <code>__dir__</code>. It is not necessarily
the directory containing the file being executed, but the directory containing
the entire toys directory structure. So if your tool definition is inside a
<code>.toys</code> directory, it will still work:</p>

<pre class="code ruby"><code class="ruby">my-project/   &lt;-- context_directory still points here
|
+- .toys/
|  |
|  +- list-tests.rb   &lt;-- tool defined here
|
+- lib/
|
+- test/
|
etc...
</code></pre>

<p>This technique is particularly useful for build tools. Indeed, all the build
tools described in the section on
<a href="#Toys_as_a_Rake_replacement">Toys as a Rake Replacement</a> automatically move
into the context directory when they execute.</p>

<h4 id="changing-the-context-directory">Changing the context directory</h4>

<p>It is even possible to modify the context directory, causing tools that use the
context directory (such as the standard build tools) to run in a different
directory. Here is an example:</p>

<p>Suppose you have a repository with multiple gems, each in its own directory:</p>

<pre class="code ruby"><code class="ruby">my-repo/
|
+- .toys.rb  &lt;-- all project tools defined here
|
+- gem1/
|  |
|  +- lib/
|  |
|  +- test/
|
+- gem2/
|  |
|  +- lib/
|  |
|  +- test/
|
etc...
</code></pre>

<p>Assuming all the gems use the same set of build tools, it is possible to define
those tools once in a single <code>.toys.rb</code> file and have it run in a particular
gem directory depending on your current location. For example, you can cd into
<code>gem1</code> or even <code>gem1/lib</code> to have the tools run on <code>gem1</code>. Because the standard
build tools execute within the context directory, you can accomplish this by
setting the context directory to the gem directory corresponding to the current
location. That is, if the working directory is <code>my-repo/gem1/lib</code>, set the
context directory to <code>my-repo/gem1</code>. Here&#39;s what that could look like:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># .toys.rb content
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pathname</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_base_dir'>base_dir</span> <span class='op'>=</span> <span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_context_directory'>context_directory</span>
<span class='id identifier rubyid_cur_dir'>cur_dir</span> <span class='op'>=</span> <span class='const'>Pathname</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='const'>Dir</span><span class='period'>.</span><span class='id identifier rubyid_getwd'>getwd</span>

<span class='comment'># The gem name is the first segment of the relative path from the context
</span><span class='comment'># directory to the current directory.
</span><span class='id identifier rubyid_relative_path'>relative_path</span> <span class='op'>=</span> <span class='id identifier rubyid_cur_dir'>cur_dir</span><span class='period'>.</span><span class='id identifier rubyid_relative_path_from'>relative_path_from</span><span class='lparen'>(</span><span class='id identifier rubyid_base_dir'>base_dir</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
<span class='id identifier rubyid_gem_name'>gem_name</span> <span class='op'>=</span> <span class='id identifier rubyid_relative_path'>relative_path</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

<span class='comment'># Only proceed if we&#39;re truly in a subdirectory
</span><span class='kw'>if</span> <span class='id identifier rubyid_gem_name'>gem_name</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_gem_name'>gem_name</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_gem_name'>gem_name</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>..</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Now set the context directory to the gem directory.
</span>  <span class='id identifier rubyid_set_context_directory'>set_context_directory</span> <span class='id identifier rubyid_base_dir'>base_dir</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_gem_name'>gem_name</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

  <span class='comment'># Define the build tools. Each of these uses the custom context directory
</span>  <span class='comment'># set above, and thus runs for the selected gem.
</span>  <span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:minitest</span>
  <span class='id identifier rubyid_expand'>expand</span> <span class='symbol'>:gem_build</span>
  <span class='comment'># etc.
</span><span class='kw'>end</span>
</code></pre>

<h3 id="hidden-tools">Hidden tools</h3>

<p>Tools whose name begins with an underscore (e.g. <code>_foo</code>) are called &quot;hidden&quot;
tools. They can be executed the same as any other tool, but are normally
omitted from the subtool list displayed in help and usage screens. You may use
hidden tools as &quot;internal&quot; tools that are meant to be called only as part of
the implementation of other tools.</p>

<p>If you pass the <code>--all</code> flag when displaying help, the help screen will include
hidden tools in the subtools list.</p>

<h2 id="toys-administration-using-the-system-tools">Toys administration using the system tools</h2>

<p>Toys comes with a few built-in tools, including some that let you administer
Toys itself. These tools live in the <code>system</code> namespace.</p>

<h3 id="getting-the-toys-version">Getting the Toys version</h3>

<p>You can get the current version of Toys by running:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_toys'>toys</span> <span class='id identifier rubyid_system'>system</span> <span class='id identifier rubyid_version'>version</span>
</code></pre>

<p>Note that the same output can be obtained by passing the <code>--version</code> flag to
the root tool:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_toys'>toys</span> <span class='op'>-</span><span class='op'>-</span><span class='id identifier rubyid_version'>version</span>
</code></pre>

<h3 id="upgrading-toys">Upgrading Toys</h3>

<p>To update Toys to the latest released version, run:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_toys'>toys</span> <span class='id identifier rubyid_system'>system</span> <span class='id identifier rubyid_update'>update</span>
</code></pre>

<p>This will determine the latest version from Rubygems, and update your Toys
installation if it is not already current.</p>

<p>Normall it asks you for confirmation before downloading. To disable interactive
confirmation, pass the <code>--yes</code> flag.</p>

<p>A similar effect can of course be obtained by running <code>gem install toys</code>.</p>

<h3 id="installing-tab-completion-for-bash">Installing tab completion for Bash</h3>

<p>Toys provides tab completion for the bash shell, and lets tools customize the
completions for their arguments. However, you need to install the Toys
completion tool into your shell. The following command sets up tab completion
the current shell:</p>

<pre class="code ruby"><code class="ruby">$(toys system bash-completion install)
</code></pre>

<p>Typically, you will want to include the above in your <code>.bashrc</code> or other bash
initialization file.</p>

<p>By default, this associates the Toys tab completion logic with the <code>toys</code>
executable. If you have other names or aliases for the executable, pass them as
arguments. For example, I use <code>t</code> as an alias for <code>toys</code>, and I therefore
install Toys&#39;s completion logic for <code>t</code>:</p>

<pre class="code ruby"><code class="ruby">$(toys system bash-completion install t)
</code></pre>

<p>You can also remove the completion logic from the current shell:</p>

<pre class="code ruby"><code class="ruby">$(toys system bash-completion remove)
$(toys system bash-completion remove t)
</code></pre>

<p>At this time, bash is the only shell that is supported directly. If you are
using zsh, however, you can use the <code>bashcompinit</code> function to load the toys
bash completion (as well as other bash-based completions). This <em>mostly</em> works,
with a few caveats. Native zsh completion is on the future roadmap.</p>

<h2 id="writing-your-own-cli-using-toys">Writing your own CLI using Toys</h2>

<p>Although Toys is not primarily designed to help you write a custom command-line
executable, you can use it in that way. Toys is factored into two gems:
<strong>toys-core</strong>, which includes all the underlying machinery for creating
command-line executables, and <strong>toys</strong>, which is really just a wrapper that
provides the <code>toys</code> executable itself and its built-in commands and behavior.
To write your own command line executable based on the Toys system, just
require the <strong>toys-core</strong> gem and configure your executable the way you want.</p>

<p>Toys-Core is modular and lets you customize much of the behavior of a command
line executable, simply by setting options or adding plugins. For example:</p>

<ul>
<li>  Toys itself automatically adds a number of flags, such as <code>--verbose</code> and
<code>--help</code>, to each tool. Toys-Core lets you customize what flags (if any)
are automatically added for your own command line executable.</li>
<li>  Toys itself provides a default way to run tools that have no <code>run</code> method.
It assumes such tools are namespaces, and displays the online help screen.
Toys-Core lets you provide an alternate default run method for your own
command line executable.</li>
<li>  Toys itself provides several built-in tools, such as <code>do</code>, and <code>system</code>.
Toys-Core lets you write your own command line executable with its own
built-in tools.</li>
<li>  Toys itself implements a particular search path for user-provided Toys
files, and looks for specific file and directory names such as <code>.toys.rb</code>.
Toys-Core lets you change the search path, the file/directory names, or
disable user-provided Toys files altogether for your own command line
executable. Indeed, most command line executables do not need
user-customizable tools, and can ship with only built-in tools.</li>
<li>  Toys itself has a particular way of displaying online help and reporting
errors. Toys-Core lets your own command line executable customize these and
many other features.</li>
</ul>

<p>For more information, see the
<a href="https://dazuma.github.io/toys/gems/toys-core/latest/">Toys-Core documentation</a>.</p>
</div></div>

      <div id="footer">
  Generated on Sun Jul 19 00:21:23 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.25 (ruby-2.7.1).
</div>

    </div>
  </body>
</html>